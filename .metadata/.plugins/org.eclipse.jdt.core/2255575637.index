etryHandler",void 0),this.pageHandlerModule=e,this.logModule=t,this.storageHandler=new Aa(e,o.dataLoader,t),this.fixedHeaderUtilities=new Ji,this.viewModulesUtilities=new Gc(o,t,i),this.autoOpenControllerUtilities=new vi,this.autoOpenControllerUtilities.init(o,this.logModule,this.storageHandler,Lo.EdgeImpressionId),this.footerUtilities=new ca(o,this.viewModulesUtilities,e,t,this.autoOpenControllerUtilities),this.telemetryHandler=new Ha(o,this.viewModulesUtilities,e,t),this.dataValidationUtilities=new bi(o,t),this.commonAssets=i,this.tooltipUtilities=new Va(o,this.viewModulesUtilities,this.commonAssets,this.footerUtilities),this.discoverTelemetryHandler=new wi(o,t,e)}}var Vc=xc;class Kc extends Oo{constructor(...e){super(...e),a(this,"traceId",void 0),a(this,"apiResponse",void 0),a(this,"journeyStage",di.UNDEFINED),a(this,"sentSnoozeTelemetry",!1),a(this,"snoozedPopupOriginationList",[]),a(this,"bgaaComplete",void 0)}init(e){this.apiResponse=wt.getApiResponse(),this.initCommonInfo(this.apiResponse.impressionId,this.apiResponse.retailerData?.domainName??fe.GetDomainName(),this.apiResponse.url??window.location.href,R.Controller),this.traceId=e,this.sendErrorMessage=this.sendControllerErrorMessage.bind(this),this.sendStorageMessage=this.sendControllerStorageMessage.bind(this),this.sentSnoozeTelemetry=!1,this.initialize()}isCheckoutPageUsingUrlMatch(e){if(this.getNumberParameter(e,U.is_checkout_page_using_url_match))return!0;if(this.apiResponse.retailerData?.checkoutPageUrl){return me.IsOnPage(this.apiResponse.retailerData.checkoutPageUrl,location.pathname)}return!1}isMockedCheckout(){const e=this.apiResponse.retailerData?.getCurrentCheckoutPage();if(e){if(!e?.pageType)return!1;if(e?.pageType!==I.CheckoutPage)return!0}return!1}isProductPageCheckoutPageUsingUrlMatch(){if(!this.apiResponse.retailerData?.updateCurrentCheckoutPage(location.pathname))return!1;const e=this.apiResponse.retailerData?.getCurrentCheckoutPage();return e?.pageType===I.ProductPage}async checkAndTriggerProductTracking(){const{retailerData:e}=this.apiResponse;if(!e)return!1;const t=this.apiResponse.retailerData?.getCurrentCheckoutPage();if(t?.pageType!==I.ProductPage)return!1;const o=this.apiResponse.retailerData?.getCurrentCheckoutPage()?.catalogSelectors;return!!o&&li.ValidateProductOutOfStock(e,o,this.apiResponse?.impressionId,this.apiResponse?.productTracking)}getCurrentJourneyStage(){return this.journeyStage}resetCurrentJourneyStage(){this.journeyStage=di.UNDEFINED}computeCurrentJourneyStage(e){let o=di.UNDEFINED;if(c.isExperimentActive(t.disableJourneyStageComputation)){const e=c.getMultipleVariants(t.disableJourneyStageComputation),o=c.getVariantValue(e,"journeyStage",di.UNDEFINED);return void(this.journeyStage=o)}if(!(c.isExperimentActive(t.shoppingOnDiscover)&&c.isExperimentActive(t.temporalShoppingOnDiscover)||c.isExperimentActive(t.computeJourneyStage)))return;const i=c.getMultipleVariants(t.shoppingOnDiscover),a=c.getVariantValue(i,"maxCountThreshold",1),r=c.getVariantValue(i,"researchTotalCount",1),n=c.getVariantValue(i,"discoverTotalCount",1),s=c.getVariantValue(i,"decisionTotalCount",1),l=c.getVariantValue(i,"historyThresholdInMinutes",-1),u=wt.getApiResponse().shoppingDataContainer,d=u?.baseShoppingDataList;if(d){let e=0,t=0;for(const o of d)if(o?.contentDataType===Ci.PreviouslyViewedSimilar){const i=o;if(i)for(const[o,a]of Object.entries(i.urlTimestamps)){let o=0;for(const e of a)";"===e&&(o+=1);if(-1===l)e+=o,t=Math.max(t,o);else{let o=0;for(const e of a.split(";")){const t=Date.parse(e+" Z");Date.now()-t<1e3*l*60&&(o+=1)}e+=o,t=Math.max(t,o)}}}e>s?o=di.DECISION:t>a||e>r?o=di.RESEARCH:e>n&&(o=di.DISCOVER)}if(this.journeyStage=o,c.isExperimentActive(t.journeyStageTelemetry)){const t=this.getStringParameter(e,U.session_ids),i=JSON.parse(t),a=new ui(o,i?.pageVisitId);this.sendLogEventMessage(a,p.JourneyStage,this.impressionId,"",h.Information)}}getCurrentCategoryName(){const e=wt.getApiResponse().comparableOffers?.attributedatabag?.responseLevelSignals?.queryleafcategoryid;if(e&&"string"==typeof e)return e;const t=wt.getApiResponse().shoppingDataContainer;if(t){const e=t.baseShoppingDataList;for(const t of e)if(t?.contentDataType===Ci.CategoryInsights){if(t)return t.rRCategoryInsights.leafCategoryId.toString()}}return""}setAutoOpenPref(e){this.autoOpenPrefData=e,this.sendStorageMessage(uo,JSON.stringify({value:JSON.stringify(this.autoOpenPrefData)}))}async initializeUserPreference(e){try{const t=[],o=Object.keys(L).filter((e=>!isNaN(Number(e))));for(const i of o){const o=parseInt(i,10),a=Vc.GetFeatureFromPopupOrigination(o),r=this.getNumberParameter(e,U.disabled_scenarios);if(null!=r&&r<117424127&&a&&(r&a)===a){const e=new go;e.popupOrigination=o,e.timeLastAutoOpen=Date.now(),t.push(e)}if(e.length>U.snoozed_values){const i=JSON.parse(e[U.snoozed_values]);if(i&&i.length>0&&i.includes(a.toString())){const e=new go;e.popupOrigination=o,e.timeLastAutoOpen=Date.now(),e.snoozeTime=864e5,t.push(e)}}}this.sendStorageMessage(uo,JSON.stringify({value:JSON.stringify(t)})),this.autoOpenPrefData=t}catch(e){this.sendErrorMessage(`error setting user pref for the first time ${e}`)}}setPreferenceForDomain(e,t){if(!this.autoOpenDomainPrefData||!this.autoOpenDomainPrefData?.get(t)){const o=new Map,i=[];if(t){const a=Object.keys(L).filter((e=>!isNaN(Number(e))));if(e.length>U.disable_popup_originations_for_current_domain){const t=JSON.parse(e[U.disable_popup_originations_for_current_domain]);if(t&&2===t.length)for(const e of a){const o=parseInt(e,10),a=Vc.GetFeatureFromPopupOrigination(o);(this.doesGroupHaveEnum(t[0],a)||this.doesGroupHaveEnum(t[1],a))&&i.push(o)}}o.set(t,i);const r=JSON.stringify({value:JSON.stringify(o,me.StringifyMap)});this.autoOpenDomainPrefData=o,this.sendStorageMessage(Co,r)}}}isPopupOriginationUnblockedByMinCooldown(e){const t=this.lastShownData.get(e);if(t){const o=this.GetMinCooldownForPopupOrigination(e);if(o){const e=Date.now()-t>=o;return e}}return!0}isPopupOriginationUnblockedByStageAndCategory(e){if(!c.isExperimentActive(t.shoppingOnDiscover)||!c.isExperimentActive(t.temporalShoppingOnDiscover))return!0;const o=c.getMultipleVariants(t.shoppingOnDiscover),i=c.getVariantValue(o,"journeyStageCooldownInMinutes",60),a=c.getVariantValue(o,"categoryCooldownInMinutes",1440),r=this.stageAndCategoryLastShown.get(e);let n=!0;if(r){const e=this.getCurrentJourneyStage(),t=this.getCurrentCategoryName(),o=r.categoriesBlocked.get(e);if(o&&o.length>0){Date.now()-o[o.length-1].timeLastAutoOpen<1e3*i*60&&(n=!1);for(const e of o)if(Date.now()-e.timeLastAutoOpen<1e3*a*60&&e.categoryName===t){n=!1;break}}}return n}sendControllerStorageMessage(e,t){this.sendMessage(si.SetStorageValue,[e,t])}sendUpdateAddressBarMessage(e){this.sendMessage(si.UpdateAddressBar,[e])}isPopupOriginationUnblockedByUserPref(e,o,i,a,r=!1){if(this.autoOpenPrefData&&c?.isExperimentActive(t.autoOpenControllerScript)){const n={Domain:fe.GetDomainName(),Status:"blockedByPref",PopupOrigination:o,Reason:"",PrefSize:this.autoOpenPrefData?.length},s=this.autoOpenPrefData.findIndex((e=>e.popupOrigination===o));if(-1!==s){const a=Date.now(),l=this.autoOpenPrefData[s].timeLastAutoOpen,u=this.autoOpenPrefData[s].snoozeTime;if(!u){if(c.isExperimentActive(t.lostUsersCashBack)&&this.lostUsersPopupOriginationCashBack(o,i))return n.Reason="blocked but recovered - CashBack",this.sendLogEventMessage(n,p.UserPref,this.impressionId,"",h.Information),!0;if(c.isExperimentActive(t.lostUsersCouponClipping)&&this.lostUsersPopupOriginationCouponClipping(o,i))return n.Reason="blocked but recovered - Clipping",this.sendLogEventMessage(n,p.UserPref,this.impressionId,"",h.Information),!0;n.Reason="blocked";const a=this.autoOpenPrefData.filter((e=>!e.snoozeTime));return n.PrefSize=a?.length,a?.length>=29&&(this.autoOpenPrefData=this.autoOpenPrefData.filter((e=>e.snoozeTime)),this.setAutoOpenPref(this.autoOpenPrefData),n.Status="prefReset",n.Reason="maxedOut"),this.sendLogEventMessage(n,p.UserPref,this.impressionId,"",h.Information),this.sendAutoShowPreventedMessage(o,e),!1}if(a-l<u)return r&&this.snoozedPopupOriginationList.push(o),this.sendAutoShowPreventedMessage(o,e),!1}if(this.autoOpenDomainPrefData&&a&&this.autoOpenDomainPrefData.get(a)){const t=this.autoOpenDomainPrefData.get(a);if(t?.includes(o))return n.Reason="blocked for domain",this.sendLogEventMessage(n,p.UserPref,this.impressionId,"",h.Information),this.sendAutoShowPreventedMessage(o,e),!1}else{const t=Vc.GetFeatureFromPopupOrigination(o);if(e?.length>U.disable_popup_originations_for_current_domain){const i=JSON.parse(e[U.disable_popup_originations_for_current_domain]);if(i&&2===i.length&&(this.doesGroupHaveEnum(i[0],t)||this.doesGroupHaveEnum(i[1],t)))return n.Reason="blocked for domain using params",this.sendLogEventMessage(n,p.UserPref,this.impressionId,"",h.Information),this.sendAutoShowPreventedMessage(o,e),!1}}return!0}if(e){const t=Vc.GetFeatureFromPopupOrigination(o),i=this.getNumberParameter(e,U.disabled_scenarios);if(null!=i&&t&&(i&t)===t)return this.sendAutoShowPreventedMessage(o,e),!1;if(e?.length>U.disable_popup_originations_for_current_domain){const i=JSON.parse(e[U.disable_popup_originations_for_current_domain]);if(i&&2===i.length&&(this.doesGroupHaveEnum(i[0],t)||this.doesGroupHaveEnum(i[1],t)))return this.sendAutoShowPreventedMessage(o,e),!1}if(e?.length>U.snoozed_values){const i=JSON.parse(e[U.snoozed_values]);if(i&&i.length>0&&i.includes(t.toString()))return this.sendAutoShowPreventedMessage(o,e),!1}}return!0}sendLogEventMessage(e,t,o,i,a){const r={};r.JsonData=JSON.stringify(e),r.EventType=t,r.LogLevel=a,r.Message=i,r.ClientContext=new De(G.GetClientName(),be,G.GetBuildVersion(),G.enabledServiceFlights),o&&(r.ImpressionId=o);const n=[JSON.stringify(r)];this.sendMessage(si.LogScriptTelemetry,n)}sendLogEventMessageV2(e,t,o,i,a){const r={};r.JsonData=JSON.stringify(e),r.EventType=t,r.LogLevel=a,r.Message=i,r.ClientContext=new De(G.GetClientName(),be,G.GetBuildVersion(),G.enabledServiceFlights),o&&(r.ImpressionId=o);const n=[JSON.stringify(r)];try{this.sendMessage(si.LogScriptTelemetryV2,n)}catch(e){}}sendThrottledLogEventMessage(e){c.isExperimentActive(t.loggingThrottle)&&e()}isPopupOriginationUnblockedByServer(e){try{const t=this.apiResponse.retailerData?.disabledPopupOriginationList,o=t?.find((t=>t.popupOrigination===e));if(o){if(!o.jSVersionThreshold&&!o.serverExps)return!1;if(o.jSVersionThreshold&&Number(be)<Number(o.jSVersionThreshold))return!1;if(o.serverExps){const e=o.serverExps;for(const t of e){const e=`edgeServerUX.shopping.${t}`;if(c.isExperimentActive(e))return!1}}}}catch(e){this.sendLogEvent(this.apiResponse.impressionId,`popupOrgination unblocked by server ${e}`,"error")}return!0}isLowPerformingNotificationBlockedByExperiment(e){return c.isExperimentActive(t.blockLowPerformanceNotifications)&&Kc.lowPerformingNotificationsExp.includes(e)}CheckIfCanOpenForPopupOrigination(e,t,o,i,a){let r,n=!1,s=!1,c=!1,l=!1,u=!1,d=!1;const C=this.apiResponse?.disabledNotifications;r=$e(e),n=r.status,n&&(s=!this.shouldStandDown(t,e),n=s),n&&(n=!i),n&&(c=this.isPopupOriginationUnblockedByServer(e),n=c),n&&(l=this.isPopupOriginationUnblockedByMinCooldown(e),n=l),n&&(n=this.isPopupOriginationUnblockedByStageAndCategory(e)),n&&(n=this.checkIfCanOpenWithPersonalization(e)),n&&(u=this.isPopupOriginationUnblocked(e,C),n=u),n&&(d=this.isPopupOriginationUnblockedByUserPref(t,e,C,o,!0),n=d),n&&(n=!this.isLowPerformingNotificationBlockedByExperiment(e));let h;if(this.enableAutoShowBlockedLogging(e)&&!n){let t="Popup origination blocked";r.status?s?i?(t="Popup origination blocked due to already auto opened",h=JSON.stringify(a)):c?l?u?d||(t="Popup origination blocked due to userPref"):t="Popup origination blocked due to domain":t="Popup origination blocked due to MinCooldown":t="Popup origination blocked by server":t="Popup origination blocked due to stand down parameter":t=`Popup origination blocked due to reason: ${r.reason}`,this.sendLogEvent(this.apiResponse.impressionId,"BLOCKED POPUPORIGINATION",t,e.toString(),h?{featuresAlreadyOpened:h}:void 0)}return!!n}enableAutoShowBlockedLogging(e){return e===L.AUTO_SHOW_SPB_CASHBACK_LANDING||e===L.AUTO_SHOW_LOWER_PRICE_FOUND}sendMessage(e,t){tt.postMessageToHost(e,t)}sendLogEvent(e,t,o,i,a){const r={Domain:fe.GetDomainName(),PageUrl:fe.GetPageUrl(),Status:o,PopupOrigination:i,Metadata:a?JSON.stringify(a):void 0};this.sendLogEventMessage(r,p.AutoOpenController,e,t,h.Information)}sendSnoozeTelemetry(){if(0===this.snoozedPopupOriginationList.length||this.sentSnoozeTelemetry)return;this.sentSnoozeTelemetry=!0;const e={Domain:fe.GetDomainName(),Status:"blockedByPref",PopupOrigination:JSON.stringify(this.snoozedPopupOriginationList),Reason:"snoozed",PrefSize:0},t=this.autoOpenPrefData.filter((e=>e.snoozeTime));e.PrefSize=t?.length,this.sendLogEventMessage(e,p.UserPref,this.apiResponse.impressionId,"",h.Information)}checkUrlParam(e,t,o){return o.get(e)===t}setIsClientBgaaComplete(e){this.bgaaComplete=e}getIsClientBgaaComplete(){return this.bgaaComplete}shouldCheckIfCanOpenWithPersonalization(e){return!!(e===L.AUTO_SHOW_COUPONS_CHECKOUT&&c.isExperimentActive(t.CouponsPersonalization)||e===L.AUTO_SHOW_PRICE_HISTORY&&c.isExperimentActive(t.PhPersonalization)||e===L.AUTO_SHOW_REBATES_ORGANIC&&c.isExperimentActive(t.CashbackPersonalization))}checkIfCanOpenWithPersonalization(e){if(!1===this.shouldCheckIfCanOpenWithPersonalization(e))return!0;try{const t=ai.getRuleBasedTriggerController(e,this.sendErrorMessage,this.sendStorageMessage,this.apiResponse.impressionId,V?.RuleBasedTriggerData),o=t.canAutoOpen();if(o);else{const o=new fo(O.PersonalizedAutoTriggerOff);o.Metadata=JSON.stringify({personalizationAutoOpenTelemetryData:t.getPersonalizationAutoOpenTelemetryData(),popupOriginationEnum:e}),this.sendLogEventMessage(o,p.EdgeFlyoutStatus,this.apiResponse.impressionId,"RuleBased Trigger Controller decides to not auto open the flyout",h.Information)}return o}catch(e){return this.sendErrorMessage(this.apiResponse.impressionId,`checkIfCanOpenWithPersonalization error ${Vc.GetErrorString(e)}`),!0}}shouldStandDown(e,t){return!(!Wc.getNumberParameter(e,U.should_stand_down)||Kc.shouldNotStandDown.includes(t))&&(Wc.isCheckoutPageUsingUrlMatch(e)&&(this.sendMessage(Pe.PageStatus,[this.traceId,""]),this.sendMessage(Pe.CheckoutPageValidationStatus,["false",this.traceId,"false"])),!0)}initialize(){this.autoOpenDataStr=V?.AutoOpenData,this.lastCleanedDataStr=V?.LastCleanedData,this.autoOpenPrefDataStr=V?.AutoOpenPrefData,this.autoOpenDomainPrefDataStr=V?.AutoOpenDomainPrefData,this.lastShownDataStr=V?.LastShownData,this.stageAndCategoryLastShownStr=V?.StageAndCategoryLastShown,this.initializeData()}sendControllerErrorMessage(e,t){try{const o="error";this.sendLogEvent(e,t,o),this.sendMessage(si.AutoOpenError,[o,this.traceId])}catch(e){}}sendAutoShowPreventedMessage(e,t){e?.toString()&&this.sendMessage(si.RecordAutoShowPrevented,[t[U.nagivation_guid],e.toString()])}}a(Kc,"lowPerformingNotificationsExp",[L.AUTO_SHOW_REBATES,L.AUTO_SHOW_REBATES_ORGANIC_NEW,L.AUTO_SHOW_EXPRESS_CHECKOUT,L.AUTO_SHOW_SUSTAINABILITY_LANDING,L.AUTO_SHOW_GIFT_CARD,L.AUTO_SHOW_GROCERY_ITEMIZED_CASHBACK,L.AUTO_PRODUCT_TRACKING_OUT_OF_STOCK]),a(Kc,"shouldNotStandDown",[L.AUTO_SHOW_REBATES_ACTIVATION_FAILED,L.AUTO_SHOW_REBATES_SWITCHED_TO_MSA,L.AUTO_SHOW_REWARDS_ACTIVATION_FAILED,L.AUTO_SHOW_REWARDS_SWITCHED_TO_MSA,L.AUTO_SHOW_PERSONALIZED_CASHBACK,L.AUTO_SHOW_SERVER_DRIVEN_NOTIFICATION,L.AUTO_SHOW_REBATES_CONFIRMATION,L.AUTO_SHOW_PERSONALIZED_CASHBACK_CONFIRMATION]);const Wc=new Kc;class zc{static executeUrlParamActions(e,t){const o=fe.GetBingUrlFromBingNavChain(t)??window.location.search,i=new URLSearchParams(o),a=zc.getParamActionMap();i.forEach(((t,o)=>{const i=a.get(`${o}:${t}`);i&&i.forEach((t=>{t(e)}))}))}static fireAffiliateUrl(e){const t=e.retailerData?.domainName??fe.GetDomainName(),o=e?.coupons?.find((e=>fe.IsAffiliateCoupon(e,t)))?.offerUrl;o&&at.SendNavigateToUrlMessage(o)}static getParamActionMap(){const e=new Map;return e.set("datasource:shoppingsaving",[zc.sendBellIconNotificationTelemetry,zc.fireAffiliateUrl]),e.set("formcode:edgeshopping",[zc.fireAffiliateUrl]),e}static sendBellIconNotificationTelemetry(e){const t=e.retailerData?.domainName??fe.GetDomainName();Wc.sendMessage(Pe.RecordShoppingUserAction,[ni.BellIconNotifClick]),Wc.sendMessage(Pe.RecordShoppingUserEngagement,[ri.BellIconNotifClick]);const o=new Eo(g.BellIconNotification,Po.BELL_ICON,t);Wc.sendLogEventMessage(o,p.ButtonClick,e.impressionId,"Bell Icon Notification Click",h.Information)}}var Yc=zc;var Jc=class{constructor(){a(this,"apiResponse",void 0),a(this,"BestCouponConsentData",void 0),a(this,"domainName",void 0),a(this,"aaConsentData",void 0)}async Init(){this.apiResponse=wt.getApiResponse(),this.domainName=this.apiResponse.retailerData?.domainName??fe.GetDomainName(),this.BestCouponConsentData=fe.GetStorageObject(V.ProductBestCouponConsent),this.apiResponse.retailerData?.aaConsentEnabled&&(this.aaConsentData=fe.GetStorageObject(V.rawStorageObj[Jt.GetAAConsentStorageKey(this.domainName)]))}GetPopupOriginationList(){return[L.AUTO_SHOW_PRODUCT_BEST_COUPON_CONSENT]}async CanAutoOpenForFeature(e){const o=this.apiResponse.retailerData.allProductPages;if(c.isExperimentActive(t.autoShowBGAA)&&o.length>0)for(let e=0;e<o.length;e++){if(this.apiResponse.retailerData.allProductPages[e].backgroundAAEnabled)return!1}return!!("true"!==Zt("CanOpenAAConsent")&&!this.isAutoTriggeredAAAllowed()&&this.apiResponse.productBestCoupon?.coupon||await this.searchHasBestCoupon(e))}async PostValidation(){}isAutoApplyingBestCouponAllowed(){if(!this.BestCouponConsentData||!this.BestCouponConsentData[this.domainName]?.allowed)return!1;const e=Qt(this.BestCouponConsentData[this.domainName].timeStamp);return e>=0&&e<1||(delete this.BestCouponConsentData[this.domainName],at.SendStorageMessage(x.ProductBestCouponConsent,JSON.stringify({value:JSON.stringify(this.BestCouponConsentData)})),!1)}AutoApplyBestCoupon(){this.BestCouponConsentData&&this.BestCouponConsentData[this.domainName]?.productBestCoupon&&(at.StartEdgeDriver("",JSON.stringify({action:jt.ApplyProductBestCoupon,data:{productBestCoupon:this.BestCouponConsentData[this.domainName].productBestCoupon}})),Yc.fireAffiliateUrl(this.apiResponse),delete this.BestCouponConsentData[this.domainName],at.SendStorageMessage(x.ProductBestCouponConsent,JSON.stringify({value:JSON.stringify(this.BestCouponConsentData)})))}isAutoTriggeredAAAllowed(){if(!this.aaConsentData?.allowed)return!1;const e=Qt(this.aaConsentData.timeStamp);return e>=0&&e<1}async searchHasBestCoupon(e){const t=this.apiResponse.retailerData.allCheckoutPages.find((e=>e.pageType===I.SearchPage)),o=t?.checkoutPageUrl,i=window.location.href.toLocaleLowerCase();let a=!1;if(o&&i&&t.productTitleSearchSelector){const e=o.split(",");for(const t of e){const e=new RegExp(t).exec(i);if(e&&e.length>0){a=!0;break}}}return t&&a&&me.WaitForCondition((async()=>Be.HasVisibleElement(t.productTitleSearchSelector)),1e3).then((async()=>{const o=document.querySelectorAll(t.productTitleSearchSelector);if(o?.length>0)for(let t=0;t<o.length&&t<3;t++){let i=o[t].textContent?.replace(/[\n\r]+|[\s]{2,}/g," ")?.trim()??"";const a=this.apiResponse.retailerData?.domainName??fe.GetDomainName();"macys.com"===a&&i&&(i=i.replace(/[\w]+   /g,"")),await this.fetchBestCouponForProduct(i,a).then((t=>{if(void 0!==t?.coupon&&void 0!==t?.couponType){t.product=i,Wc.sendControllerStorageMessage(x.ProductBestCoupon,JSON.stringify({value:JSON.stringify(t)}));const o=new CustomEvent(re,{detail:{popupOrigination:e}});return window.dispatchEvent(o),!0}}))}})),!1}async fetchBestCouponForProduct(e,t){const o={Domain:t,ProductName:e},i={headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(o)};try{const e="https://www.bing.com/api/shopping/v1/savings/cartProcessing/getProductBestCoupon",t=await fetch(e,i);return await t.json()}catch(e){}}};var jc=class{constructor(){a(this,"apiResponse",void 0),a(this,"domainName",void 0),a(this,"ExclusiveCouponConsentWithDomain",void 0),a(this,"aaConsentData",void 0)}async Init(){this.apiResponse=wt.getApiResponse(),this.domainName=this.apiResponse.retailerData?.domainName??fe.GetDomainName(),this.ExclusiveCouponConsentWithDomain=fe.GetStorageObject(V.ExclusiveCouponConsent)??{},this.apiResponse.retailerData?.aaConsentEnabled&&(this.aaConsentData=fe.GetStorageObject(V.rawStorageObj[Jt.GetAAConsentStorageKey(this.domainName)]))}GetPopupOriginationList(){return[L.AUTO_SHOW_ABANDONED_CART]}async CanAutoOpenForFeature(e){const o=this.apiResponse.retailerData.allProductPages;if(c.isExperimentActive(t.autoShowBGAA)&&o.length>0)for(let e=0;e<o.length;e++){if(this.apiResponse.retailerData.allProductPages[e].backgroundAAEnabled)return!1}return"true"!==Zt("CanOpenAAConsent")&&!this.isAutoTriggeredAAAllowed()}async PostValidation(){}isAutoApplyingExclusiveCouponAllowed(){if(!this.ExclusiveCouponConsentWithDomain||!this.ExclusiveCouponConsentWithDomain[this.domainName]?.allowed)return!1;const e=Qt(this.ExclusiveCouponConsentWithDomain[this.domainName].timeStamp);return e>=0&&e<1||(delete this.ExclusiveCouponConsentWithDomain[this.domainName],at.SendStorageMessage(x.ExclusiveCouponConsent,JSON.stringify({value:JSON.stringify(this.ExclusiveCouponConsentWithDomain)})),!1)}AutoApplyExclusiveCoupon(){this.ExclusiveCouponConsentWithDomain&&this.ExclusiveCouponConsentWithDomain[this.domainName]?.exclusiveCoupon&&(at.StartEdgeDriver("",JSON.stringify({action:jt.ApplyExclusiveCoupon,data:{exclusiveCoupon:this.ExclusiveCouponConsentWithDomain[this.domainName].exclusiveCoupon}})),Yc.fireAffiliateUrl(this.apiResponse),delete this.ExclusiveCouponConsentWithDomain[this.domainName],at.SendStorageMessage(x.ExclusiveCouponConsent,JSON.stringify({value:JSON.stringify(this.ExclusiveCouponConsentWithDomain)})))}isAutoTriggeredAAAllowed(){if(!this.aaConsentData?.allowed)return!1;const e=Qt(this.aaConsentData.timeStamp);return e>=0&&e<1}};var Xc=class{constructor(){a(this,"checkoutPageUrlData",void 0),a(this,"apiResponse",void 0),a(this,"domainName",void 0),a(this,"isPageValid",void 0),a(this,"aaValidationReason",void 0),a(this,"canOpen",void 0),a(this,"totalPrice",void 0),a(this,"localDataService",void 0),a(this,"validator",void 0),a(this,"aocValidatorUtilities",void 0),a(this,"bgaaService",void 0)}GetPopupOriginationList(){return[L.AUTO_SHOW_COUPONS_CHECKOUT,L.AUTO_SHOW_COUPONS_CHECKOUT_MICRO_NOTIFICATION]}async CanAutoOpenForFeature(e){if((this.checkoutPageUrlData?.pageType??I.CheckoutPage)!==I.CheckoutPage)return Promise.resolve(!1);c.isExperimentActive(t.autofillAutoPopup)&&this.setAttributeForInputBox(),this.totalPrice=this.GetTotalPrice(),this.aaValidationReason=await this.IsAAValid(),this.isPageValid=this.aaValidationReason===to.PageIsValid;const o=this.localDataService.IsExpressCheckoutPage(),i={auto_apply_status:this.isPageValid,express_checkout_status:o,open_micro_notifcation:!1,page_validations:[],page_validations_auto_open:[]};if(!this.isPageValid){if(this.aaValidationReason===to.PageIsInvalid&&this.apiResponse.retailerData?.multiMsgValidationEnabled){const e=_o.GetInitialFields(this.apiResponse);me.ObserveUntil((()=>this.validator.IsPageValid(e)),(()=>{this.validator.SendValidationMessage(!0,to.PageBecameValid,this.domainName,void 0,!Ze(),!1,i);const e=new CustomEvent(re,{detail:{popupOrigination:L.AUTO_SHOW_COUPONS_CHECKOUT}});window.dispatchEvent(e)}))}return this.validator.SendValidationMessage(this.isPageValid,this.aaValidationReason,this.domainName,void 0,!1,!1,i),Promise.resolve(!1)}let a=null;const r=c.isExperimentActive(t.ProductPageBackgroundAutoApply),n=at.ParseBackgroundAutoApplyStateData(V.rawStorageObj);r&&n&&this.checkoutPageUrlData&&(a=await this.bgaaService.TryValidateBackgroundAutoApplyState(n,this.localDataService.GetMarket(),this.checkoutPageUrlData)),this.SetTotalPrice(),this.canOpen=await this.shouldAutoOpenForAA(i);const s=c.isExperimentActive(t.autoShowBGAA),l=V.BGAAApplyButtonClicked;(a===m.Positive&&l==="true_"+this.domainName||a===m.Negative)&&this.canOpen&&s&&(this.canOpen=!1,at.SendStringStorageMessage(x.BGAAApplyButtonClicked,"false_"+this.domainName));if(c.isExperimentActive(t.suppressAAAutoApplyThreshold))try{const e=c.getServiceExperimentValue(t.suppressAAAutoApplyThreshold),o=c.getServiceExperimentValue(t.suppressAADomainSuccessThreshold);if(o&&e){const t=parseInt(o,10),i=parseInt(e,10),a=V.UnsuccessfulAutoApplyCount;a&&i>0&&t>0&&this.canOpen&&a>=i&&(this.canOpen=this.HasHighConfidenceCouponsDomainLevel(t));const r=new fo(O.SuppressAutoApply),n=this.apiResponse?.retailerData?.retailerTrivia?.successRate;n&&0===n&&(this.canOpen=!1);const s=this.canOpen;r.Domain=this.domainName,r.Metadata=JSON.stringify({unsuccessfulAACount:a,aaFailureThreshold:i,domainThreshold:t,currentDomainSuccesRate:n,canOpen:s}),at.SendLogEvent(this.apiResponse.impressionId,"Suppress auto apply experiement result telemetry","",void 0,void 0,p.EdgeFlyoutStatus,r,this.domainName)}}catch(e){at.SendLogEvent(this.apiResponse.impressionId,"Suppress auto apply experiment error:"+e?.message,"error",void 0,void 0,p.AutoApply)}const u=new io;u.Init();const d=new Jc;d.Init();const C=new jc;return C.Init(),u.isAutoTriggeredAAAllowed()?(this.validator.SendValidationMessage(this.isPageValid,this.aaValidationReason,this.domainName,void 0,!1,!1,i),this.canOpen=!1,u.AutoTriggerAutoApply(null!=a)):d.isAutoApplyingBestCouponAllowed()?(this.validator.SendValidationMessage(this.isPageValid,this.aaValidationReason,this.domainName,void 0,!Ze()&&this.canOpen,!1,i),d.AutoApplyBestCoupon()):C.isAutoApplyingExclusiveCouponAllowed()?(this.validator.SendValidationMessage(this.isPageValid,this.aaValidationReason,this.domainName,void 0,!1,!1,i),C.AutoApplyExclusiveCoupon()):this.validator.SendValidationMessage(this.isPageValid,this.aaValidationReason,this.domainName,void 0,!Ze()&&this.canOpen,!1,i),Promise.resolve(this.canOpen)}Init(){return this.apiResponse=wt.getApiResponse(),this.apiResponse.retailerData.updateCurrentCheckoutPage(_o.GetCurrentPathName()),this.checkoutPageUrlData=this.apiResponse.retailerData.getCurrentCheckoutPage(),this.domainName=this.apiResponse.retailerData.domainName,this.localDataService=nd.GetLocalDataService(),this.validator=nd.GetValidatorModule(),this.aocValidatorUtilities=_o.GetValidatorAutoOpenController(),this.bgaaService=nd.GetBackgroundAAService(),Promise.resolve()}PostValidation(){return _o.GetAndSendOrderTotal(this.localDataService.GetMarket(),this.isPageValid,this.aaValidationReason),Promise.resolve()}GetTotalPrice(){if(this.checkoutPageUrlData&&!this.checkoutPageUrlData.supportedNoOrderTotal){return at.GetOrderTotalString(this.checkoutPageUrlData.orderTotalDataElementSelector)}return""}SetTotalPrice(){this.aocValidatorUtilities&&!this.checkoutPageUrlData?.supportedNoOrderTotal&&(at.SendStorageMessage("price"+this.domainName,JSON.stringify({value:this.totalPrice})),Ze()?Wc.setTotalPrice(this.totalPrice):this.aocValidatorUtilities.setTotalPrice(this.totalPrice))}async IsAAValid(){if(!this.checkoutPageUrlData)return this.validator.sendErrorMessage(this.apiResponse.impressionId,"no checkout page url data"),to.IsPageValidError;if(!this.IsAutoApplyEnabled())return to.DisabledCheckoutPageData;const e=_o.GetInitialFields(this.apiResponse);if(0===e.length)return to.NoSelectors;if(this.apiResponse.coupons?.length>0==!1)return to.NoCoupons;if(this.checkoutPageUrlData.isHomePageSameAsCheckout&&!this.checkoutPageUrlData.supportedNoOrderTotal)try{const e=+this.totalPrice;if(!e||e<=0)return to.InvalidCartTotal}catch{return to.InvalidCartTotal}return await me.WaitForCondition((async()=>this.validator.IsPageValid(e)),5e3).then((async e=>e?(this.PrefetchAutoApplyResources(),to.PageIsValid):to.PageIsInvalid)).catch((e=>(this.validator.sendErrorMessage(this.apiResponse.impressionId,e?.message??"checkoutpage error."),to.IsPageValidError)))}PrefetchAutoApplyResources(){if(document?.body){let e=!1;const t="https://edgeshoppingstatic.azureedge.net/shoppingjsstatic/v2/Assets";window&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(e=!0);const o=document.createElement("LINK");o.setAttribute("rel","prefetch"),o.href=e?t+"Shopping_Progress_Dark_01.mp4":t+"Shopping_Progress_01.mp4",o.setAttribute("as","fetch");const i=document.createElement("LINK");i.setAttribute("rel","prefetch"),i.href=e?t+"Shopping_Success_Dark_01.mp4":t+"Shopping_Success_01.mp4",i.setAttribute("as","fetch");const a=document.createElement("LINK");a.setAttribute("rel","prefetch"),a.href=e?t+"Shopping_Finished_Dark_01.mp4":t+"Shopping_Finished_01.mp4",a.setAttribute("as","fetch"),document.body.appendChild(o),document.body.appendChild(i),document.body.appendChild(a)}}IsAutoApplyEnabled(){return!0===this.checkoutPageUrlData?.edgeEnabled}setAttributeForInputBox(){const e=this.checkoutPageUrlData?.isAutoShowDisabled;if(void 0!==this.checkoutPageUrlData&&this.checkoutPageUrlData.inputBoxSelector&&!e){const e=Be.GetFirstVisibleElement(this.checkoutPageUrlData.inputBoxSelector);e?.setAttribute("edge-shopping-apply-coupon-input-box-tag","")}}async shouldAutoOpenForAA(e){const o=e.auto_apply_status;let i=!0;Ze()||(i=this.aocValidatorUtilities.isPopupOriginationUnblocked(L.AUTO_SHOW_COUPONS_CHECKOUT));const a=c.isExperimentActive(t.CouponsPersonalization),r=this.validator.GetRuleBasedTriggerController();if(i&&a&&r&&this.apiResponse?.coupons&&this.apiResponse.coupons.length>0&&!Ze())if(i=r.canAutoOpen(),i)e.personalizationAutoOpenTelemetryData=r.getPersonalizationAutoOpenTelemetryData();else{const e=new fo(O.PersonalizedAutoTriggerOff);e.Metadata=JSON.stringify({personalizationAutoOpenTelemetryData:r.getPersonalizationAutoOpenTelemetryData(),popupOriginationEnum:L.AUTO_SHOW_COUPONS_CHECKOUT}),at.SendLogEvent(this.apiResponse.impressionId,"RuleBased Trigger Controller decides to not auto open the flyout",o?"true":"false",void 0,void 0,p.EdgeFlyoutStatus,e)}const n=c.getMultipleVariants(t.couponsConfidence),s=c.getVariantValue(n,ze.CouponLevelThreshold,-1),l=c.getVariantValue(n,ze.DomainLevelThreshold,-1);let u=!1;if(i&&s>=0){const e=this.HasHighConfidenceCouponsCouponsLevel(s);i=i&&e,u=!0}if(i&&l>=0){const e=this.HasHighConfidenceCouponsDomainLevel(l);i=i&&e,u=!0}return u||i||(i=this.shouldAutoOpenForAAMicroNotification(e)),i}shouldAutoOpenForAAMicroNotification(e){if(this.aocValidatorUtilities?.isPopupOriginationUnblocked(L.AUTO_SHOW_COUPONS_CHECKOUT_MICRO_NOTIFICATION)){const t=new ao;return t.originalPopupOrigination=L.AUTO_SHOW_COUPONS_CHECKOUT,at.SendStorageMessage("MicroNotificationData",JSON.stringify({value:t})),e.open_micro_notifcation=!0,!0}return!1}HasHighConfidenceCouponsCouponsLevel(e){let t=!1,o=!1;if(this.apiResponse?.coupons?.length)for(const i of this.apiResponse.coupons){const a=void 0===i.successRate?0:i.successRate;if(o||void 0===a||0===a||(o=!0),a>=e){t=!0;break}}return!o||t}HasHighConfidenceCouponsDomainLevel(e){let t=!0;return this.apiResponse?.retailerData?.retailerTrivia?.successRate&&(t=this.apiResponse?.retailerData?.retailerTrivia?.successRate>=e),t}};var Zc=class{constructor(){a(this,"apiResponse",void 0),a(this,"domainName",void 0),a(this,"canOpen",void 0),a(this,"localDataService",void 0),a(this,"validator",void 0),a(this,"aocValidatorUtilities",void 0),a(this,"BestCouponConsentData",void 0),a(this,"checkoutPageUrlData",void 0)}Init(){return this.apiResponse=wt.getApiResponse(),this.domainName=this.apiResponse.retailerData.domainName,this.localDataService=nd.GetLocalDataService(),this.validator=nd.GetValidatorModule(),this.aocValidatorUtilities=_o.GetValidatorAutoOpenController(),this.BestCouponConsentData=fe.GetStorageObject(V.ProductBestCouponConsent),this.checkoutPageUrlData=this.apiResponse.retailerData.getCurrentCheckoutPage(),Promise.resolve()}PostValidation(){return Promise.resolve()}GetPopupOriginationList(){return[L.AUTO_SHOW_COUPONS_BACKGROUND_AUTO_APPLY]}GetAutoOpenParams(){return JSON.stringify({bestCouponConsentData:this.BestCouponConsentData})}async CanAutoOpenForFeature(e){const o=function(e){let t;const o=de(e);if(o)try{return t=JSON.parse(o),t}catch(e){}return t}("isBgaaComplete");if(this.isCheckoutPage()||!1===o)return Promise.resolve(!1);const i=c.isExperimentActive(t.ProductPageBackgroundAutoApply),a=c.isExperimentActive(t.autoShowBGAA),r=at.ParseBackgroundAutoApplyStateData(V.rawStorageObj),n=r?.BackgroundAAStatus.domainName===this.domainName;let s=null;if(i&&a&&r&&n&&o&&(s=await this.TryValidateBackgroundAutoApplyState(r,this.localDataService.GetMarket())),this.canOpen=await this.shouldAutoOpenForBGAA(),this.canOpen&&s&&s===m.Positive){const e=new CustomEvent(re,{detail:{popupOrigination:L.AUTO_SHOW_COUPONS_BACKGROUND_AUTO_APPLY}});window.dispatchEvent(e)}else this.canOpen=!1;return(new io).Init(),this.canOpen&&o&&this.validator.SendValidationMessage(!0,to.PageIsValid,this.domainName,void 0,!Ze()&&this.canOpen,!1,void 0),pe("isBgaaComplete",!1),Promise.resolve(this.canOpen)}async TryValidateBackgroundAutoApplyState(e,t,o){try{return await this.ValidateBackgroundAutoApplyState(e,t,o)}catch(e){}return null}async ValidateBackgroundAutoApplyState(e,o,i){const a=rt.GetBackgroundAAKeyName();if(Date.now()-e.StartTime>864e5)return this.validator.DeleteKeyFromPersistentStorage(a),rt.SendBackgroundAAStateValidationMessage(""),null;const r=c.isExperimentActive(t.autoShowBGAA),n=rt.CanCurrentDomainDeleteBgaaState(e.BackgroundAAStatus.domainName);if(!n&&e.BackgroundAAStatus.expiredState&&r)return rt.SendBackgroundAAStateValidationMessage(""),null;const s=e.BackgroundAAStatus.result,l=rt.CanCurrentPageDeleteBgaaState(e.BackgroundAAStatus.pageUrl);if(!l&&e.BackgroundAAStatus.expiredState)return rt.SendBackgroundAAStateValidationMessage(""),null;if(l&&i){const t=await To.WaitAndGetCartValue(i.orderTotalDataElementSelector,o),r=await To.WaitAndGetCartValue(i.orderSubTotalElementSelector,o,1e3);return rt.ValidateBgAAState(e,t.OrderTotal,r.OrderTotal)?this.GetBgaaResult(e,s):(l?this.validator.DeleteKeyFromPersistentStorage(a):(e.BackgroundAAStatus.expiredState=!0,this.validator.SendStorageMessage(a,JSON.stringify({value:e.ToString()}))),rt.SendBackgroundAAStateValidationMessage(""),null)}return n?this.GetBgaaResult(e,s):null}GetBgaaResult(e,t){const o=Math.round(100*e.MaxDiscount)/100;(t===m.InProgress||t===m.Cancelled)&&o>0&&(t=m.Positive);const i={BestCoupon:e.BestCoupon?.couponCode,Result:t,Savings:o,SuccessfulCoupons:e.CouponResults.filter((e=>e.Discount>0)).map((e=>e.Code))};return rt.SendBackgroundAAStateValidationMessage(JSON.stringify(i)),t}isCheckoutPage(){return!!this.checkoutPageUrlData&&(this.checkoutPageUrlData.pageType!==I.ProductPage&&!(!this.checkoutPageUrlData.checkoutPageUrl||"/"===this.checkoutPageUrlData.checkoutPageUrl))}async shouldAutoOpenForBGAA(){let e=!0;return Ze()||(e=this.aocValidatorUtilities.isPopupOriginationUnblocked(L.AUTO_SHOW_COUPONS_BACKGROUND_AUTO_APPLY)),e}};var $c=class{constructor(){a(this,"enabledDomains",void 0)}};var qc=class extends Lt{constructor(e,t,o,i,r){super(),a(this,"Discount",void 0),a(this,"StartingPrice",void 0),a(this,"Domain",void 0),a(this,"ProductUrl",void 0),a(this,"DiscountString",void 0),this.StartingPrice=t??0,this.Discount=o??0,this.ProductUrl=e,this.DiscountString=i,this.Domain=r}};class Qc{constructor(){a(this,"discount",void 0),a(this,"initialPrice",void 0)}}var el=class{static getInitialPrice(e){if(e)return Te.GetPriceStringAsNumber(e)}static getAmazonClippingDiscount(e,t){let o;if(t&&e){const i=t.substring(t.search(/\d+/g)),a=i.search(/\s|%/);let r=i;-1!==a&&(r=i.substring(0,a)),o=Te.GetPriceStringAsNumber(r),t.search(/%/)>0&&(o=e*o/100)}return o}};var tl=class extends Lt{constructor(e,t){super(),a(this,"Domain",void 0),a(this,"EntryPoint",void 0),a(this,"AutoApplyResult",void 0),a(this,"CouponResults",void 0),a(this,"AutoApplyProcessTime",void 0),a(this,"BestCoupon",void 0),a(this,"Discount",void 0),a(this,"StartingPrice",void 0),a(this,"ErrorName",void 0),a(this,"Currency",void 0),a(this,"PageCurrency",void 0),a(this,"IsStackable",void 0),a(this,"AutoApplyScenario",void 0),a(this,"ExtractedSelectors",void 0),a(this,"CartExtractionId",void 0),a(this,"Market",void 0),this.Domain=e,this.EntryPoint=t??N.Shopping}SetResultData(e,t,o,i,a,r,n,s,c,l,u){this.AutoApplyResult=e,this.AutoApplyProcessTime=t,this.BestCoupon=o,this.CouponResults=i,this.Discount=a,this.StartingPrice=r,this.IsStackable=n,this.AutoApplyScenario=s,this.ExtractedSelectors=c,this.CartExtractionId=l,this.Market=u}SetErrorData(e,t){this.AutoApplyResult=e,this.ErrorName=t}SetCurrencyInfo(e,t){this.Currency=e,this.PageCurrency=t}};var ol=class extends Lt{constructor(e,t,o,i){super(),a(this,"Domain",void 0),a(this,"Data",void 0),a(this,"ErrorType",void 0),a(this,"StackTrace",void 0),this.Domain=e,this.StackTrace=i,this.Data=JSON.stringify(o),this.ErrorType=t}};var il=class extends Lt{constructor(e,t,o,i){super(),a(this,"Domain",void 0),a(this,"PreClippingVisibleSelectors",void 0),a(this,"PostClippingVisibleSelectors",void 0),a(this,"WasClippingSuccessful",void 0),this.Domain=e,this.PreClippingVisibleSelectors=t,this.PostClippingVisibleSelectors=o,this.WasClippingSuccessful=i}};var al=class{constructor(e){a(this,"EventInfoTime",void 0),a(this,"EventInfoName",void 0),a(this,"Domain",void 0),a(this,"BestCoupon",void 0),a(this,"CashbackCategory",void 0),a(this,"StartingPrice",void 0),a(this,"CashbackSavings",void 0),a(this,"Discount",void 0),a(this,"AutoApplyScenario",void 0),a(this,"AutoApplyProcessTime",void 0),a(this,"ImpressionId",void 0),a(this,"JSVersion",void 0),a(this,"BuildVersion",void 0),a(this,"Currency",void 0),this.EventInfoTime=e?.eventInfo_Time,this.EventInfoName=e?.eventInfo_Name,this.Domain=e?.domain,this.BestCoupon=e?.bestCoupon,this.CashbackCategory=e?.cashbackCategory,this.StartingPrice=e?.startingPrice,this.CashbackSavings=e?.cashbackSavings,this.Discount=e?.discount,this.AutoApplyScenario=e?.autoApplyScenario,this.AutoApplyProcessTime=e?.autoApplyProcessTime,this.ImpressionId=e?.impressionId,this.JSVersion=e?.jSVersion,this.BuildVersion=e?.buildVersion,this.Currency=e?.currency}};let rl=function(e){return e.GetBoxValue="GetBoxValue",e.GetCurrentCheckoutPage="GetCurrentCheckoutPage",e.BetterInitialPrice="BetterInitialPrice",e.CheckoutPageWithoutCoupons="CheckoutPageWithoutCoupons",e.AutoApplyWithoutCoupons="AutoApplyWithoutCoupons",e.AutoApplyWithoutCheckout="AutoApplyWithoutCheckout",e.RemoveCouponFailure="RemoveCouponFailure",e.ApplyButtonUndefined="ApplyButtonUndefined",e.InputUndefined="InputUndefined",e.GetAppliedCoupon="GetAppliedCoupon",e.CouponClippingFailed="CouponClippingFailed",e.OtherSellerFailed="OtherSellerFailed",e.ContinueButtonUndefined="ContinueButtonUndefined",e.ECIframeResponseNotReceived="ECIframeResponseNotReceived",e.ECFrameNameUndefined="ECFrameNameUndefined",e.ECFrameOriginMisMatch="ECFrameOriginMisMatch",e.ExpressCheckoutBNPLFailed="ExpressCheckoutBNPLFailed",e.ErrorParsingBackgroundAutoApplyState="ErrorParsingBackgroundAutoApplyState",e.ExpiredBackgroundAAState="ExpiredBackgroundAAState",e.GetSuggestedCoupon="GetSuggestedCoupon",e.UndefinedState="UndefinedState",e.DomainDisabled="DomainDisabled",e.BackgroundAAError="BackgroundAAError",e.BackgroundAAPDPDisabled="BackgroundAAPDPDisabled",e.SavingsFoundTransactionFailure="SavingsFoundTransactionFailure",e.ApplyButtonDisabled="ApplyButtonDisabled",e.ContinueButtonDisabled="ContinueButtonDisabled",e.CartBlockedCoupons="CartBlockedCoupons",e}({});var nl=class{constructor(e,t){a(this,"logService",void 0),a(this,"scenario",void 0),this.logService=e,this.scenario=t}async TryClipCoupons(e,t,o,i){const a=Date.now();if(!e.clipCouponSelector)return this.LogError(a,"ClipCoupon selector not found",t,o,i),!1;return await this.ClipCouponsAndLogResult(a,e,t,o,i).catch((e=>(this.LogError(a,e.message,t,o,i),!1)))}async ClipCouponsAndLogResult(e,t,o,i,a){const r=this.GetPriceData(t,i);if(!await me.WaitForCondition((async()=>Be.HasVisibleElement(t.clipCouponSelector)),3e3)&&t.clickBeforeClipSelector){const i=Be.GetAllMatchingElements(t.clickBeforeClipSelector);for(const e of i)e.click();await me.WaitForCondition((async()=>Be.HasVisibleElement(t.clipCouponSelector)),3e3).then((async t=>{if(!t){const t="Clicked before element but never found Clip Button";return this.LogError(e,t,o,r,a),!1}}))}const n=Be.GetAllMatchingElements(t.clipCouponSelector),s=this.GetFirstVisibleIndices(t);if(0===n.length){let i="Clip button not found, no AlreadyClipped selector";if(t.alreadyClippedSelector){i=Be.GetFirstVisibleElement(t.alreadyClippedSelector)?"Coupon Already Clipped":"Clip Button and Already Clipped not found"}return this.LogError(e,i,o,r,a),this.LogVisibleSelectors(o,s,[],!1,a),!1}let c=!1;for(const e of n)e.click(),c=!0;return this.GetPostClippingSelectorsAndLog(o,t,s,c,a),c?this.LogClippingResult(e,m.Positive,o,r,"Finished Clipping Coupon",a):this.LogError(e,"Coupon Clipping Failed",o,r,a),c}GetPriceData(e,t){let o=t.initialPrice??0,i=t.discount;try{if(!o&&e.orderTotalDataElementSelector){const t=Be.GetFirstVisibleElement(e.orderTotalDataElementSelector)?.innerText;t&&(o=Te.GetPriceStringAsNumber(t))}if(!i&&e.discountSelector){const t=Be.GetFirstVisibleElement(e.discountSelector)?.innerText;i=el.getAmazonClippingDiscount(o,t)}}catch(e){}return{discount:i,initialPrice:o}}async GetPostClippingSelectorsAndLog(e,t,o,i,a){await me.Sleep(1e3);const r=this.GetFirstVisibleIndices(t);this.LogVisibleSelectors(e,o,r,i,a)}GetFirstVisibleIndices(e){return[this.GetFirstVisibleElementIndex(e.clipCouponSelector),this.GetFirstVisibleElementIndex(e.discountSelector),this.GetFirstVisibleElementIndex(e.orderTotalDataElementSelector),this.GetFirstVisibleElementIndex(e.clippedDiscountSelector),this.GetFirstVisibleElementIndex(e.alreadyClippedSelector)]}GetFirstVisibleElementIndex(e){if(!e)return-2;const t=e.split(";");for(let e=0;e<t.length;e++){const o=t[e];try{const t=document.querySelectorAll(o);for(const o of t)if(Be.IsElementVisible(o))return e}catch(e){}}return-1}LogVisibleSelectors(e,t,o,i,a){const r=p.VisibleClippingSelectors,n=h.Information,s=new il(e,t,o,i);this.logService.SendLogMessage(n,r,"",s,a)}LogClippingResult(e,t,o,i,a,r){const n=i.initialPrice??0,s=i.discount??0,c=Date.now()-e,l=new tl(o),u="Amazon Coupon";l.SetResultData(t,c,u,[],s??0,n,!1,this.scenario);const d=p.AutoApply,C=h.Information;if(this.logService.SendLogMessage(C,d,a,l,r),t===m.Positive){this.logService.SendEdgeAAPositiveResult(u,n,s);try{const e=new al({});e.EventInfoTime=(new Date).toISOString(),e.Domain=o,e.BestCoupon=u,e.StartingPrice=n.toString(),e.Discount=s.toString(),e.AutoApplyScenario=this.scenario,e.AutoApplyProcessTime=c.toString(),this.logService.SaveSavingsTransactionToEdge(e)}catch(e){}}else this.logService.SendEdgeAANegativeResult()}LogError(e,t,o,i,a){const r=rl.CouponClippingFailed,n=new ol(o,r,{FunctionName:"ClipCoupons"},void 0);this.logService.SendLogMessage(h.Error,p.ClientError,t??"",n,a),this.logService.SendEdgeAAErrorMessage(r),this.LogClippingResult(e,m.Error,o,i,t,a)}};var sl=class{SendLogMessage(e,t,o,i,a){at.SendLogEventMessage(i,t,a,o,e)}SaveSavingsTransactionToEdge(e){at.SendStorageMessage(v.CouponClippingTransactionsKey,JSON.stringify({value:JSON.stringify(e)}))}SendEdgeAANegativeResult(){}SendEdgeAAPositiveResult(e,t,o){}SendEdgeAAErrorMessage(e){}};var cl=class{constructor(){a(this,"checkoutPageUrlData",void 0),a(this,"localDataService",void 0),a(this,"domainName",void 0),a(this,"impressionId",void 0),a(this,"traceId",void 0),a(this,"validator",void 0),a(this,"rakutenJP","rakuten.co.jp")}GetPopupOriginationList(){return[L.AUTO_SHOW_COUPONS_CLIPPING]}async CanAutoOpenForFeature(e){const t=await this.waitForIsClippingScenario(this.checkoutPageUrlData);if(!t||!this.checkoutPageUrlData?.clippingSelectors)return Promise.resolve(!1);const o=this.getAutoClipData();if(!o?.includes(this.domainName))return t&&(this.validator.SendValidationMessage(!1,to.Clipping,this.domainName,[b.COUPONS_CLIPPING]),this.localDataService.SetIsClippingSent(!0)),Promise.resolve(t);const i=new nl(new sl,P.AutoCouponClipping);return await i.TryClipCoupons(this.checkoutPageUrlData.clippingSelectors,this.domainName,new Qc,this.impressionId)&&(at.SendMessage(Pe.RecordShoppingUserEngagement,[ri.CouponClipping]),at.SendMessage(Pe.RecordShoppingUserAction,[ni.CouponClipping])),Promise.resolve(!1)}Init(){return this.localDataService=nd.GetLocalDataService(),this.domainName=this.localDataService.GetDomainName(),this.checkoutPageUrlData=this.localDataService.GetCheckoutPageData().retailerData.getCurrentCheckoutPage(location.pathname),this.validator=nd.GetValidatorModule(),this.checkoutPageUrlData,Promise.resolve()}PostValidation(){return Promise.resolve()}async waitForIsClippingScenario(e){const t=e?.clippingSelectors;if(!t?.discountSelector||!t?.signedInSelector)return!1;const o=t.waitForPageLoad;o&&await me.Sleep(o);const i=await this.isClippingPage(t),a=await this.isClippingScenario(t,i),r=await this.logIfClippingExist(t,i);return a&&r}getAutoClipData(){if(V?.AutoClipData){let e=new $c;try{e=fe.GetStorageObject(V.AutoClipData)}catch{at.DeleteKeyFromPersistentStorage(x.AutoClipData)}return e.enabledDomains}}isClippingScenario(e,t){let o;const i=Be.HasVisibleElement(e.signedInSelector);if(this.domainName===this.rakutenJP){let a=Be.HasVisibleElement(e.clipCouponSelector);if(!a){const t=Be.GetFirstVisibleElement(e.clickBeforeClipSelector);t?.click(),a=Be.HasVisibleElement(e.clipCouponSelector)}o=t&&(i||!!e.isSignInOptional)&&a}else{const a=Be.HasVisibleElement(e.alreadyClippedSelector);o=t&&(i||!!e.isSignInOptional)&&!a}return o}logIfClippingExist(e,t){if(!t)return!1;try{const t=Be.GetFirstVisibleElement(e.orderTotalDataElementSelector),o=t?.innerText??"";let i,a;if(o.includes("-")){const e=o.split("-");i=el.getInitialPrice(e[0]),a=el.getInitialPrice(e[1])}else i=el.getInitialPrice(o);const r=this.getDiscount(i,a,e);if(!r)return!1;const n=new qc(location.pathname,i,r.discount,r.discountString,fe.GetDomainName());at.SendLogEventMessage(n,p.ClippingExist,this.impressionId,"There is clipping",h.Information)}catch(e){at.SendLogEvent(this.impressionId,"Error while logging clipping data : "+e?.message,"error",void 0,void 0,void 0),at.SendMessage(Pe.CheckoutPageValidationError,["error",this.traceId])}return!0}isClippingPage(e){const t=Be.HasVisibleElement(e.clickBeforeClipSelector),o=Be.HasVisibleElement(e.clipCouponSelector);return t||o}getDiscount(e,t,o){let i;if(this.domainName===this.rakutenJP){const t=[];let a=Be.GetAllMatchingElements(o.discountSelector);if(!a.length){const e=Be.GetFirstVisibleElement(o.clickBeforeClipSelector);if(e?.click(),a=Be.GetAllMatchingElements(o.discountSelector),!a)return}a.forEach((o=>{const i="%"===o.childNodes[1].textContent||"％"===o.childNodes[1].textContent?Te.GetPriceStringAsNumber(o.childNodes[0].textContent??"0")*e:Te.GetPriceStringAsNumber(o.childNodes[0].textContent??"0");t.push(i)})),t.sort(((e,t)=>e-t)),i={discount:t[0],maxDiscount:t[t.length-1],discountString:t[0].toString()}}else{const a=Be.GetFirstVisibleElement(o.discountSelector),r=a?.innerText??"";if(r.includes("-")){const n=r.split("-"),s=el.getAmazonClippingDiscount(e,n[0])??0,c=el.getAmazonClippingDiscount(e,n[1])??0;let l=0,u=0;if(o.isSalePriceNotDiscount)if(t){const o=0===s?0:e-s,i=0===c?0:t-c;l=Math.min(o,i),u=Math.max(o,i)}else u=0===s?0:e-s,l=0===c?0:e-c;else l=s,u=c;i={discount:l,maxDiscount:u,discountString:a?.innerText??""}}else{let t=el.getAmazonClippingDiscount(e,r)??0;o.isSalePriceNotDiscount&&(t=0===t?0:e-t),i={discount:t??0,maxDiscount:t??0,discountString:a?.innerText??""}}}return i}};class ll{constructor(){a(this,"isOffTheRecord",void 0),a(this,"buildVersion",void 0)}static Create(e){const t=new ll;return t.isOffTheRecord=e?.clientInfo?.isOffTheRecord??void 0,t.buildVersion=e?.clientInfo?.buildVersion,t}}var ul=ll;class dl{constructor(){a(this,"SearchData",void 0),a(this,"CategoryData",void 0),a(this,"PdpData",void 0),a(this,"AddedToCartData",void 0),a(this,"CustomAutoShowData",void 0),a(this,"categoryAutoShowCooldownInSeconds",void 0)}static Create(e){let t=new dl;if(e)try{const o=atob(e);t=JSON.parse(o)}catch(e){}return t}}var Cl=dl;let hl=function(e){return e.variation1="variation1",e.variation2="variation2",e.variation3="variation3",e.variation4="variation4",e.variation5="variation5",e.variation6="variation6",e.variation7="variation7",e.variation8="variation8",e.variation9="variation9",e.autoActivationVariation="autoActivationVariation",e.pdpExactMatch="pdpExactMatch",e.spbCartPageAutoActivationVariation="spbCartPageAutoActivationVariation",e.spbAADLinkingNotification="spbAADLinkingNotification",e}({}),pl=function(e){return e.Quotient="q",e.Ibotta="i",e.Self="s",e.FirstParty="1p",e.SPB="spb",e.Unknown="unknown",e}({}),gl=function(e){return e.Search="search",e.Category="category",e.Offers="offers",e.SearchInPane="searchpane",e.SearchInPaneMain="searchpaneMain",e.CategoryInPane="categorypane",e.OnShorelineOpen="onShorelineOpen",e}({});function Sl(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,i)}return o}function Ol(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?Sl(Object(o),!0).forEach((function(t){a(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):Sl(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}class Al{static LogSPBTelemetry(e,t,o,i,a,r={}){const n=new fo(e);n.Metadata=JSON.stringify(Ol({userInfo:i,responseData:o},r)),at.SendLogEvent(a,t,"",void 0,void 0,p.EdgeFlyoutStatus,n)}static MakeImageUrl(e,t){return e?e.startsWith("/th?")?`https://th.bing.com${e}`:e.startsWith("edge://image?https")?e.substring(13):e:t?.common?.resourcesEndpoint?t.common.resourcesEndpoint+"common/defaultProduct.svg":""}static getRecentOffers(e,t){const o=(e?ka.ParseWithErrorCatch(e):void 0)??{};return o[t]?Object.values(o[t]).sort(((e,t)=>(t.lastSeenTimestamp||0)-(e.lastSeenTimestamp||0))):[]}static IsPdpPage(e,t){const o={isPdp:!1,productId:""};if(t&&t.PdpData){const i=this.IsUrlMatchAll(e,t.PdpData);o.isPdp=i.isMatch,o.productId=i.matchKey}return o}static IsSearchPage(e,t){const o={isSerp:!1,searchKey:""};if(t&&t.SearchData){const i=this.IsUrlMatchAll(e,t.SearchData);o.isSerp=i.isMatch,o.searchKey=i.matchKey}return o}static IsUrlMatchAll(e,t){for(const o of t){const t=this.IsUrlMatch(e,o);if(t.isMatch)return t}return{isMatch:!1,matchKey:""}}static GetNonActivatedItems(e,t){if(!t||!e)return e;const o=new Set,i=new Set,a=new Set;Al.ProcessActivatedData(o,a,i,t);return this.FilterActivatedItems(e,i,o,a)}static GetSPBCashbackOffers(e){let t=[];return e&&e.itemizedCashBackResponse&&e.itemizedCashBackResponse.offers&&e.itemizedCashBackResponse.offers.length>0&&(t=e.itemizedCashBackResponse.offers),t}static GetSpbVisibilityFeedbackUrlBase(e){return e?.itemizedCashBackResponse?.adsMetadata?.visibilityFeedbackUrl||""}static GetSPBCashbackOffersPdp(e){const t=e?.offer?e.offer:void 0,o=e?.relatedOffers;return{exactMatch:t,relatedOffers:o||[],visibilityFeedbackUrl:e?.adsMetadata?.visibilityFeedbackUrl||""}}static GetTotalCashback(e){const t=e?.map((e=>{const t=Number(e?.offerValue);return isNaN(t)?0:t})).reduce(((e,t)=>e+t),0);return t||0}static GetTotalCashbackFromOffers(e){const t=e?.map((e=>{const t=Number(e?.value);return isNaN(t)?0:t})).reduce(((e,t)=>e+t),0);return t||0}static GetActivatedAdsOfferIdsAndUrls(e){const t=new Set,o=new Set,i=new Set;if(e){t.add(e.offerId);const a=this.GetUrl(this.GetDestinationUrl(e.destinationUrl));a&&o.add(a),Al.ProcessActivatedData(o,i,t,e)}return{activatedOfferIds:t,activatedDestinationUrls:o,activatedDestinationUrlPathnames:i}}static GetPdpOfferPageForActivatedAd(e,t,o){const i={adsCashbackItem:void 0,currentPageProductId:"",activatedProductIds:new Set};try{const a=this.GetUrl(e.common.lastCommittedURL);if(!a)return void ka.LogError(e,t,"Error in IsPdpPageForActivatedAd. Cannot create url",void 0);const r=Al.IsPdpPage(a,o);if(!r.isPdp||!r.productId)return;i.currentPageProductId=r.productId;const n=e.dataStoreModule.CashBackData?.personalizedCashback?.adsCashback??[];if(0===n.length)return i;let s;for(const e of n){const t=this.GetDestinationUrl(e.destinationUrl)||this.GetDestinationUrl(e.productUrl),a=this.GetUrl(t),n=a?Al.IsPdpPage(a,o):void 0,c=n?.productId;c&&(i.activatedProductIds.add(c),c===r.productId&&(s=e))}return i.adsCashbackItem=s,i}catch(o){return ka.LogError(e,t,"Error in IsPdpPageForActivatedAd",o,void 0,Ol({},i)),i}}static GetDestinationUrl(e){if(!e)return"";let t=e;if(e.includes("&l1=")){const o=e.split("&l1=");o.length>1&&(t=o[1])}else if(e.includes("dest_url=")){const o=e.split("dest_url=");o.length>1&&(t=o[1])}return t}static GetUrl(e){try{if(!e)return;return new URL(this.GetDestinationUrl(e))}catch(t){ka.LogError(void 0,void 0,"Error in GetUrl for "+e,t)}}static IsVariationString(e,t,o){const i=e.GetData("variations"),a=(i?ka.ParseWithErrorCatch(i):{})[t];return!(!a||a!==o)}static GetSpbHomePageNotificationText(e,t){const o=e.strings.gcSpbHomePageTextDefault;try{const i=e.dataStoreModule.SPBItemizedCashbackData?.homePageSpbOffers?.autoShowVariation;if(i===hl.variation1){const i=this.GetCashbackValue(e);return i||t.LogICSpecificTelemetry(O.ICHomeNotificationError,"SPB micro notification - no GetCashbackValue",A.HomePageNotification,{notificationText:o}),i?e.strings.gcSpbHomePageText1.replace("$1",`$${i}`):o}{const i=this.GetNumberOfOffers(e);return i||t.LogICSpecificTelemetry(O.ICHomeNotificationError,"SPB micro notification - no GetNumberOfOffers",A.HomePageNotification,{notificationText:o}),i?e.strings.gcSpbHomePageText2.replace("$1",i.toString()):o}}catch(e){return t.LogICSpecificTelemetry(O.ICHomeNotificationError,"SPB micro notification - unknown error. Returning default text",A.HomePageNotification,{notificationText:o}),o}}static GetCashbackValue(e){const t=e.dataStoreModule.SPBItemizedCashbackData?.homePageSpbOffers?.homePageSpbOffers||[];let o=0;return t.forEach((e=>{e?.adsOffer?.promotionInformation?.rebateValue>o&&(o=e.adsOffer.promotionInformation.rebateValue)})),o}static GetNumberOfOffers(e){const t=e.dataStoreModule.SPBItemizedCashbackData?.homePageSpbOffers?.homePageSpbOffers||[],o=e.dataStoreModule.GroceryCashbackData?.Cashback?.ItemizedCashback||[];return t.length+o.length}static ProcessActivatedData(e,t,o,i){const a=Date.now();i.adsCashback?.forEach((i=>{if(!(a>1e3*i.expireTimeEpoch)&&(i.globalOfferId&&o.add(i.globalOfferId),i.destinationUrl)){const o=this.GetDestinationUrl(i.destinationUrl),a=this.GetUrl(o);a&&(t.add(a.pathname),e.add(a))}}))}static FilterActivatedItems(e,t,o,i){return e.filter((e=>{if(e.pathname)return!i.has(e.pathname);const t=this.GetDestinationUrl(e.adsOffer.destinationUrl),o=this.GetUrl(t);return!o||!i.has(o.pathname)}))}static IsUrlMatch(e,t){let o={isMatch:!1,matchKey:""};return"PathAndParameter"===t.type?o=this.UrlPathParameterMatch(e,t.path,t.parameter):"PathRegexAndParameter"===t.type?o=this.UrlPathRegexParameterMatch(e,t.path,t.parameter):"QueryParam"===t.type?o=this.UrlQueryParameterMatch(e,t.parameter):"PathRegex"===t.type?o=this.UrlPathRegextMatch(e,t.regexData):"ParamRegex"===t.type&&(o=this.UrlParamRegex(e,t.parameter,t.regexData)),o}static UrlParamRegex(e,t,o){let i="",a=!1;const r=e.searchParams.get(t);if(o&&r){const e=r.match(o.regex),t=o.indices;for(const o of t)if(e&&e.length>o&&e[o]){i=e[o],a=!0;break}}return{isMatch:a,matchKey:i}}static UrlPathParameterMatch(e,t,o){let i="";const a=e.searchParams.get(o),r=e.pathname.toLowerCase(),n=(r===(t=t.toLowerCase())||r===t+"/"||r.endsWith(t)||r.endsWith(t+"/"))&&null!=a;return n&&null!=a&&(i=a),{isMatch:n,matchKey:i}}static UrlPathRegexParameterMatch(e,t,o){let i="";const a=e.searchParams.get(o),r=new RegExp(t).test(e.pathname)&&null!=a;return r&&null!=a&&(i=a),{isMatch:r,matchKey:i}}static UrlQueryParameterMatch(e,t){let o="";const i=e.searchParams.get(t),a=null!=i;return a&&null!=i&&(o=i),{isMatch:a,matchKey:o}}static UrlPathRegextMatch(e,t){let o="",i=!1;if(t){const a=e.pathname.match(t.regex),r=t.indices;for(const e of r)if(a&&a.length>e&&a[e]){o=a[e],i=!0;break}}return{isMatch:i,matchKey:o}}}var ml=Al;const Il=e=>!!e&&(!!e.shouldAutoShow&&(e.offersType===pl.SPB&&!!(e.offer||e.relatedOffers&&0!==e.relatedOffers.length))),Tl=(e,t,o,i,a)=>{if(!0===a)return!1;if(!e)return!1;if(!e.shouldAutoShow)return!1;if(e.offersType!==pl.Quotient)return!1;if(!(e.offer||e.relatedOffers&&0!==e.relatedOffers.length))return!1;if(V.ICIsPendingTransactionPresent)return!1;const r=new Set([...i,...Nl(t)]),n=new Set(o);let s=!1;return e.offer?.id&&(s=!r.has(e.offer.id)&&!n.has(e.offer.id)&&0!==e.offer.cashbackProducts.length),!!s},_l=(e,t,o,i=!1)=>{const a=new fo(O.ICSpbOffersNoShowHomePage);a.Metadata=JSON.stringify({userInfo:e,isError:i,pageTitle:document?.title,reason:o}),at.SendLogEvent(t,"SPB notification not shown on home page","",void 0,void 0,p.EdgeFlyoutStatus,a)},fl=(e,t,o,i,a=!1)=>{const r=e?.offersType===pl.SPB,n=new fo(r?O.ICSPBPdpOffersNoShow:O.ICQtPdpOffersNoShow),s=`${e?.offersType} offer not shown`;n.Metadata=JSON.stringify({userInfo:t,responseData:e,isExactMatch:!!e?.offer,relatedOffersLength:e?.relatedOffers?.length||0,isPdpSpb:r,isPdpQt:e?.offersType===pl.Quotient,isError:a,pageTitle:document?.title}),at.SendLogEvent(o,s,"",void 0,void 0,p.EdgeFlyoutStatus,n)},El=(e,t,o)=>{const i={isExactMatch:!!e.offer,relatedOffersLength:e.relatedOffers?.length||0,isPdpSpb:!0,pageTitle:document?.title};ml.LogSPBTelemetry(O.ICQtPdpOffersShow,"Qt pdp shown",e,t,o,i)},Pl=(e,t,o)=>{const i={isExactMatch:!!e.offer,relatedOffersLength:e.relatedOffers?.length||0,isPdpSpb:!0,pageTitle:document?.title};ml.LogSPBTelemetry(O.ICSPBPdpOffersShow,"Spb pdp shown",e,t,o,i)},Nl=e=>{try{const t=V?.GroceryCashbackActivated,o=(ka.ParseWithErrorCatch(t)??{})[e]??void 0;return o?.fullItems?Object.keys(o.fullItems):[]}catch(e){return[]}};class vl{constructor(){a(this,"apiResponse",void 0),a(this,"useMicroNotificationForSpbHomePage",!1),a(this,"hasSpbExpiryNotifyVariation",!1),a(this,"hasSpbAddToCartNotifyVariation",!1),a(this,"autoActivationOnCartPage",!1),a(this,"itemLevelCashback",void 0),a(this,"domainName",void 0),a(this,"cartExtractionService",void 0)}static hasCashbackFromPCResponse(e,t=!1){const o=(e?.value||[]).find((e=>e.position===J.SPB_OFFERS));return!!(o&&o?.offer&&o?.promotionInformation)&&(!t||"true"===o.offerLevelSignals?.autoshow)}Init(){this.apiResponse=wt.getApiResponse();const e=this.apiResponse?.itemLevelCashBack?.variations?new Map(Object.entries(this.apiResponse?.itemLevelCashBack?.variations)):new Map,o=e?.get("autoShowSpbHomePageUX")||hl.variation1;this.useMicroNotificationForSpbHomePage=o===hl.variation1||o===hl.variation2,this.hasSpbExpiryNotifyVariation=e?.get("spbExpiryNotifyVariation")===hl.variation1;const i=c.getServiceExperimentValue(t.spbAddToCart);if(this.hasSpbAddToCartNotifyVariation="variation1"===i,this.autoActivationOnCartPage=c.isTestFlagActive(s.msShoppingTestExp10)||c.isExperimentActive(t.spbCheckoutAutoActivation)||c.isExperimentActive(t.qtCartPageAutoActivation),this.itemLevelCashback=this.apiResponse.itemLevelCashBack,this.domainName=this.apiResponse.retailerData.domainName,this.autoActivationOnCartPage){try{if("amazon.com"===this.domainName||"target.com"===this.domainName||"walmart.com"===this.domainName){const e=nd.GetLocalDataService(),t=(e?.GetCheckoutPageData()||this.apiResponse).retailerData.getCurrentCheckoutPage(location.pathname);if(t?.pageType===I.CheckoutPage){let e;const t=new Promise((t=>setTimeout(e=t,2e3)));return this.cartExtractionService=nd.GetCartExtractionService(),this.cartExtractionService.subscribe(e),this.cartExtractionService.Init(),t}}}catch(e){const t=new fo(O.CartPageCashbackNotification);t.Metadata=JSON.stringify({}),t.Domain=this.domainName,at.SendLogEventMessage(t,p.EdgeFlyoutStatus,this.apiResponse.impressionId,e.message,h.Error)}this.autoActivationOnCartPage=!1}return Promise.resolve()}PostValidation(){return Promise.resolve()}GetPopupOriginationList(){return[L.AUTO_SHOW_SPB_CASHBACK_LANDING,L.AUTO_SHOW_GROCERY_ITEMIZED_CASHBACK,L.AUTO_SHOW_GROCERY_ITEMIZED_CASHBACK_LANDING,L.AUTO_SHOW_SPB_CHECK_OUT_PAGE_NOTIFICATION,L.AUTO_SHOW_SPB_MICRO_NOTIFICATION,L.AUTO_SHOW_SPB_NUDGE_MICRO_NOTIFICATION,L.AUTO_SHOW_ADD_SPB_TO_CART_MICRO_NOTIFICATION]}async CanAutoOpenForFeature(e){const t=V?.ICIsPendingTransactionPresent??!1,o=nd.GetICValidatorService();if(o.GetPopupOriginationList().includes(e)){if(Ze()){await o.Init();if(await o.CanAutoOpen()){const e=nd.GetLocalDataService(),t=nd.GetValidatorModule();(e.GetICNotificationType()===Ee.GroceryAutoShow||e.GetICNotificationType()===Ee.AddedToCartPDP||e.GetICNotificationType()===Ee.SpbHomePage)&&t.SendValidationMessage(!1,to.GroceryCashback,this.apiResponse.retailerData?.domainName??"",[b.GROCERY_ITEMIZED_CASHBACK_LANDING])}}return await this.handleICGroceryCashback(e,t)}if(e===L.AUTO_SHOW_SPB_MICRO_NOTIFICATION){if(!this.useMicroNotificationForSpbHomePage)return Promise.resolve(!1);if(this.hasHomePageSpbData(this.apiResponse))return Promise.resolve(!0)}else if(this.hasSpbExpiryNotifyVariation&&e===L.AUTO_SHOW_SPB_NUDGE_MICRO_NOTIFICATION){const e=this.apiResponse?.personalizedAdsResponse?.personalizedCashback,t=e||void 0;if(this.checkLastShownExpiryTime()&&t?.adsCashback&&t?.adsCashback?.length>0){let e=!1;return t?.adsCashback.forEach((t=>{const o=this.getSpbOfferExpiryTime(Date.now(),1e3*t.expireTimeEpoch).elapsedHours,i=c.isTestFlagActive(s.msShoppingTestExp12);(o<6||i)&&(e=!0)})),Promise.resolve(e)}}else if(this.hasSpbAddToCartNotifyVariation&&e===L.AUTO_SHOW_ADD_SPB_TO_CART_MICRO_NOTIFICATION){const e=_o.CreateCheckoutPageData(this.apiResponse),t=this.apiResponse?.personalizedAdsResponse?.personalizedCashback,o=t||void 0;if(e&&o?.adsCashback&&o?.adsCashback?.length>0){const t=e.retailerData.getCurrentCheckoutPage(location.pathname);if(t&&t.pageType===I.CheckoutPage){const e=new Set;o.adsCashback.forEach((t=>{e.add(t.scope)}));const t=this.cartExtractionService.GetAvailableCartData();if(t?.Products){t.Products.forEach((t=>{e[t.productTitle]&&e.delete(t.productTitle)}));const o=e.values().next().value;if(o&&""!==o&&null!==o)return Promise.resolve(!0)}}}}else if(this.isSpbCheckoutFlagActive()&&e===L.AUTO_SHOW_SPB_CHECK_OUT_PAGE_NOTIFICATION)try{if(this.isCheckoutPage()){const t=this.cartExtractionService.GetAvailableCartData(),o=[];this.GetSpbCartOffers(o).then((()=>{const i=this.ProcessSpbCheckOutPage(o,t);if(i&&i.length>0){Wc.sendControllerStorageMessage(x.GroceryMatchedCartSpbOffers,JSON.stringify({value:i})),Wc.sendControllerStorageMessage(x.ICNotificationType,JSON.stringify({value:Ee.SpbCartPageNotification}));const t=new CustomEvent(re,{detail:{popupOrigination:e}});window.dispatchEvent(t)}}))}}catch(e){const t=new fo(O.SPBCheckoutNotification);t.Metadata=JSON.stringify({}),t.Domain=this.domainName,at.SendLogEventMessage(t,p.EdgeFlyoutStatus,this.apiResponse.impressionId,e.message,h.Error)}return Promise.resolve(!1)}handleICGroceryCashback(e,t){if(e===L.AUTO_SHOW_SPB_CASHBACK_LANDING){if(!this.useMicroNotificationForSpbHomePage){if(this.hasHomePageSpbData(this.apiResponse)){const e=Ee.SpbHomePage;return Wc.sendControllerStorageMessage(x.ICNotificationType,JSON.stringify({value:e})),Promise.resolve(!0)}}return vl.hasCashbackFromPCResponse(this.apiResponse.comparableOffers)?Promise.resolve(!0):Promise.resolve(this.hasDataForPdpSpb(this.apiResponse))}if(e===L.AUTO_SHOW_GROCERY_ITEMIZED_CASHBACK_LANDING)return t?(fl(this.apiResponse.productItemizedCashBack,this.apiResponse.userInfo,this.apiResponse.impressionId),Promise.resolve(!1)):Promise.resolve(this.hasDataForPdpQt(this.apiResponse));if(e===L.AUTO_SHOW_GROCERY_ITEMIZED_CASHBACK){if(this.autoActivationOnCartPage){const e=this.ActivateQTOfferOnCartPageNotification();return Promise.resolve(e)}const e=this.IsInstantAddToCart(),t=this.hasActivatedQt()||this.shouldShowcofirmationNotification();if(e&&t)try{const e=this.apiResponse.productItemizedCashBack.offer?.value,t=this.apiResponse.productItemizedCashBack.offer?.minQty,o=this.apiResponse.productItemizedCashBack.offer?.description,i=this.apiResponse.productItemizedCashBack.offer?.expiryDate,a=this.apiResponse.productItemizedCashBack.offer?.source,r=this.apiResponse.productItemizedCashBack.offer?.id,n=this.domainName,s=fe.GetPageUrl(),c=this.apiResponse.productItemizedCashBack.offer?.cashbackProducts.find((e=>e.url===s));return at.StartEdgeDriver("",JSON.stringify({action:jt.InstantAddToCart,data:{value:e,minQty:t,description:o,expiryDate:i,source:a,id:r,domain:n,productUrl:s,quotientProductDetails:c}})),Promise.resolve(!1)}catch{return Promise.resolve(!1)}return Promise.resolve(t)}return Promise.resolve(!1)}checkLastShownExpiryTime(){c.isTestFlagActive(s.msShoppingTestExp12);const e=V.ICSpbExpiryNotificationShownTime||"0",t=Number(e),o=isNaN(t)?0:t,i=(new Date).getTime();return i-o>144e5&&(Wc.sendControllerStorageMessage(x.ICSpbExpiryNotificationShownTime,`${i}`),!0)}getSpbOfferExpiryTime(e,t){let o=t-e;o<0&&(o=0);const i=6e4,a=36e5;let r=o/a;o%=a,r|=0;let n=o/i;return o%=i,n|=0,{elapsedHours:r,elapsedMinutes:n}}hasHomePageSpbData(e){try{const t=e.itemLevelCashBack.spbHomePageOffers;if(!t)return!1;if(!t.find((e=>e.shouldAutoshow&&e.offersType===pl.SPB&&e.offers?.length>0)))return _l(e.userInfo,e.impressionId,"no spb home offer to autoshow for micro notification",!1),!1;const o=nd.GetLocalDataService(),i=o?.GetCheckoutPageData()||e,a=i?.retailerData?.getCurrentCheckoutPage();return a?.pageType===I.HomePage}catch(t){_l(e.userInfo,e.impressionId,"has error processing home page data for SPB",!0)}return!1}IsInstantAddToCart(){const e=this.domainName,o=c.isExperimentActive(t.instantAddToCart)||c.isExperimentActive(t.instantAddToCartExperiment),i="amazon.com"===e,a=this.hasInstantAddToCartConsent();return o&&i&&a}hasInstantAddToCartConsent(){const e=!!V?.GroceryInstantAddToCart;return e&&Wc.sendControllerStorageMessage(x.GroceryInstantAddToCart,JSON.stringify({value:!1})),e}IsConfirmationPage(e){const t=nd.GetLocalDataService(),o=t?.GetCheckoutPageData()||e,i=o?.retailerData?.getCurrentCheckoutPage();return i?.pageType===I.ConfirmationPage}ActivateQTOfferOnCartPageNotification(){this.apiResponse.personalizedAdsResponse;try{const e=nd.GetLocalDataService(),o=e?.GetCheckoutPageData()||this.apiResponse,i=o.retailerData.getCurrentCheckoutPage(location.pathname);if(o&&this.cartExtractionService&&i?.pageType===I.CheckoutPage&&this.itemLevelCashback?.itemizedCashback&&this.itemLevelCashback?.itemizedCashback?.length>0&&this.itemLevelCashback?.domainData){const e=Cl.Create(this.itemLevelCashback.domainData);if(o.retailerData.getCurrentCheckoutPage(location.pathname)){const o=new Map,i=new Map;this.itemLevelCashback.itemizedCashback.forEach((e=>{e.cashbackProducts.forEach((t=>{o.set(t.productId,t),i.set(t.productId,e)}))}));const a=c.isExperimentActive(t.autosJatoDeals);if(this.itemLevelCashback.activatedOffers&&!a){this.itemLevelCashback.activatedOffers.forEach((e=>{e.cashbackProducts.forEach((e=>{o.delete(e.productId)}))}));const e=de("activatedProductId");e&&o.delete(e)}const r=this.cartExtractionService.GetAvailableCartData();if(r?.Products){let t;if(r.Products.forEach((a=>{const r=this.normalizeUrl(this.domainName,a.productUrl);if(r){const a=ml.IsPdpPage(r,e),n=i.get(a.productId),s=o.get(a.productId);n&&s&&(t=Ra.CreateFromUAPI(n),t.cashbackProducts=[],t.cashbackProducts.push(va.CreateFromUAPI(s)))}})),null!==t&&t){ge("activatedProductId",t.cashbackProducts[0].productId),t.expAfterActivatingDate||(t.expAfterActivatingDate=(new Date).getTime()+864e5),Wc.sendControllerStorageMessage(x.CartPageCashbackNotification,JSON.stringify({value:t})),Wc.sendControllerStorageMessage(x.ICNotificationType,JSON.stringify({value:Ee.CartPageNotification}));const e=new fo(O.CartPageCashbackNotification);return e.Metadata=JSON.stringify({offer:t}),e.Domain=this.domainName,at.SendLogEventMessage(e,p.EdgeFlyoutStatus,this.apiResponse.impressionId,"QT product for auto actiovation found",h.Information),!0}}}}}catch(e){const t=new fo(O.CartPageCashbackNotification);t.Metadata=JSON.stringify({}),t.Domain=this.domainName,at.SendLogEventMessage(t,p.EdgeFlyoutStatus,this.apiResponse.impressionId,e.message,h.Error)}return!1}shouldShowcofirmationNotification(){const e=fe.GetStorageObject(V.ICPendingTransaction)??{},t=this.apiResponse.retailerData?.domainName||"";return!!(e&&e[t]&&this.IsConfirmationPage(this.apiResponse))}hasActivatedQt(){const e=!!V?.GroceryCashbackItem&&!!V?.ICActivatedPending;if(e){const e=Ee.Activated;Wc.sendControllerStorageMessage(x.ICNotificationType,JSON.stringify({value:e})),Wc.sendControllerStorageMessage(x.ICActivatedPending,JSON.stringify({value:!1}))}return e}hasDataForPdpSpb(e){try{if(!Il(e.productItemizedCashBack))return!1;const t=Ee.PdpSPB,o={};return o.cashbackData=this.apiResponse.productItemizedCashBack,o.currentUrl=fe.GetPageUrl(),o.type=t,o.pageTitle=fe.GetPageTitle(),Pl(e.productItemizedCashBack,e.userInfo,e.impressionId),Wc.sendControllerStorageMessage(x.ICCurrentPageInfo,JSON.stringify({value:JSON.stringify(o)})),Wc.sendControllerStorageMessage(x.ICNotificationType,JSON.stringify({value:t})),!0}catch(t){fl(e.productItemizedCashBack,e.userInfo,e.impressionId,0,!0)}return!1}ProcessSpbCheckOutPage(e,t){try{if(t){const o=this.GetCartProductIds(t),i=this.GetRelatedCartSpbOffers(e),a=this.FilterActivatedOffers(i);return this.GetMatchedSpbOffers(o,a)}}catch(e){const t=new fo(O.SPBCheckoutNotification);return t.Metadata=JSON.stringify({}),t.Domain=this.domainName,void at.SendLogEventMessage(t,p.EdgeFlyoutStatus,this.apiResponse.impressionId,e.message,h.Error)}}GetMatchedSpbOffers(e,t){const o=[];return e.forEach((e=>{const i=t[e];i&&i.adsOffer&&i.adsOffer.promotionInformation&&o.push(i)})),o}GetCartProductIds(e){const t=[],o=e?.Products.map((e=>this.normalizeUrl(this.domainName,e.productUrl)));for(const e of o)if(e){const o=this.GetProductId(e);o&&t.push(o)}return t}GetProductId(e){if(this.itemLevelCashback?.domainData){const t=Cl.Create(this.itemLevelCashback.domainData);if(e){const o=ml.IsPdpPage(e,t);if(o)return o.productId}}}FilterSpbOffers(e,t){return e.forEach((e=>{e&&e.source&&"spb"===e.source&&t.push(e)})),t}FilterActivatedOffers(e){const t=[],o=Object.keys(e),i=this.apiResponse?.personalizedAdsResponse?.personalizedCashback,a=i||void 0;if(a?.adsCashback&&a?.adsCashback?.length>0){const e=a?.adsCashback;e.forEach((e=>{if(e&&e?.destinationUrl){const o=this.normalizeUrl(this.domainName,e?.destinationUrl);if(o){const e=this.GetProductId(o);e&&t.push(e)}}}))}const r=o.filter((e=>!t.includes(e))),n={};for(const t of r)n[t]=e[t];return n}GetRelatedCartSpbOffers(e){const t=[];e.forEach((e=>{if(e.cashbackData&&e.cashbackData.itemizedCashBackResponse&&e.cashbackData.itemizedCashBackResponse.offers){const o=e.cashbackData.itemizedCashBackResponse.offers;this.FilterSpbOffers(o,t)}}));const o={};for(const e of t)if(e.adsOffer&&e.adsOffer.destinationUrl){const t=this.GetProductId(new URL(e.adsOffer.destinationUrl));t&&(o[t]=e)}return o}normalizeUrl(e,t){return t?t.startsWith("http")?new URL(t):new URL(`https://www.${e}${t}`):null}hasDataForPdpQt(e){try{const t=e.retailerData?.domainName||"",o=e.itemLevelCashBack?.submittedOfferIds||[],i=e.itemLevelCashBack?.activatedOffers?.map((e=>e.id))||[];if(!Tl(e.productItemizedCashBack,t,o,i))return!1;const a=Ee.PDP,r={};return r.cashbackData=e.productItemizedCashBack,r.currentUrl=fe.GetPageUrl(),r.type=a,r.pageTitle=fe.GetPageTitle(),Wc.sendControllerStorageMessage(x.ICCurrentPageInfo,JSON.stringify({value:JSON.stringify(r)})),Wc.sendControllerStorageMessage(x.ICNotificationType,JSON.stringify({value:a})),El(e.productItemizedCashBack,e.userInfo,e.impressionId),!0}catch(t){fl(e.productItemizedCashBack,e.userInfo,e.impressionId,0,!0)}return!1}async GetSpbCartOffers(e){return new Promise((t=>{const o=this.cartExtractionService.GetAvailableCartData();if(o?.Products&&this.isCheckoutPage()&&this.isSpbCheckoutFlagActive()){const i=o?.Products.map((e=>e.productTitle));this.searchWithKeywords(i);const a=o=>{e.push(o?.detail?.jsonResponse),e.length===i.length&&t(!0)};window.addEventListener(ne,a),setTimeout((()=>{window.removeEventListener(ne,a),t(!0)}),700)}else t(!0)}))}isCheckoutPage(){const e=_o.CreateCheckoutPageData(this.apiResponse).retailerData.getCurrentCheckoutPage(location.pathname);return e&&e.pageType===I.CheckoutPage}isSpbCheckoutFlagActive(){return"amazon.com"===this.domainName&&c.isExperimentActive(t.spbCheckoutAutoActivation)}async searchWithKeywords(e){const t=this.apiResponse.retailerData.domainName,o=ul.Create(this.apiResponse),i=nd.GetICValidatorService();await i.Init();const a={appName:G.GetClientName(),buildVersion:o?.buildVersion,enabledfeatures:c.GetExpRawData()},r=e.map((async e=>{try{return i.SendGetCashbackMessage(t,e,gl.Search,a)}catch(e){return null}}));return await Promise.all(r)}}var Dl=vl;var Rl=class extends Lt{constructor(...e){super(...e),a(this,"Domain",void 0),a(this,"Savings",void 0),a(this,"InitialPrice",void 0),a(this,"Currency",void 0),a(this,"Result",void 0),a(this,"PageCurrency",void 0)}SetResultData(e,t,o,i,a,r){this.Domain=e,this.Savings=t??0,this.InitialPrice=o??0,this.Currency=i,this.PageCurrency=a,this.Result=r}};class yl{constructor(){a(this,"heading",void 0),a(this,"price",void 0),a(this,"delivery",void 0),a(this,"soldBy",void 0),a(this,"rating",void 0),a(this,"sellerUrl",void 0),a(this,"index",void 0),a(this,"totalPrice",void 0),a(this,"currency",void 0)}static Create(e){const t=new yl;return t.heading=e.heading,t.price=e.price,t.soldBy=e.soldBy,t.delivery=e.delivery,t.rating=e.rating,t.sellerUrl=e.sellerUrl,t.currency=e.currency,t}}var bl=yl;class Ul{constructor(){a(this,"otherSellers",void 0),a(this,"productImage",void 0),a(this,"productPrice",void 0),a(this,"currency",void 0),a(this,"productUrl",void 0),a(this,"dataCreationTime",void 0)}static Create(e){const t=new Ul;return t.productImage=e.productImage,t.productPrice=e.productPrice,t.productUrl=e.productUrl,t.currency=e.currency,t.otherSellers=new Array,e.otherSellers.forEach((e=>{t.otherSellers.push(e)})),t}}var Ml=Ul;class wl{constructor(){a(this,"ProductAddedNotification",void 0),a(this,"Url",void 0)}static Create(e){const t=new wl;return t.ProductAddedNotification=e.ProductAddedNotification,t.Url=e.Url,t}}var Ll=wl;var kl=class{constructor(){a(this,"localDataService",void 0),a(this,"validatorModule",void 0),a(this,"isConfirmationScenario",void 0),a(this,"domainName",void 0),a(this,"checkoutPageUrlData",void 0)}async Init(){try{if(this.localDataService=nd.GetLocalDataService(),this.validatorModule=nd.GetValidatorModule(),this.domainName=this.localDataService.GetDomainName(),this.checkoutPageUrlData=this.localDataService.GetCheckoutPageData().retailerData.getCurrentCheckoutPage(_o.GetCurrentPathName()),!this.checkoutPageUrlData||!this.ShouldTriggerOtherSellers(this.checkoutPageUrlData))return;this.ManageOtherSellersData(_o.GetCurrentPathName(),V.storageObjStr,V.rawStorageObj);const e=this.GetOtherSellersNotificationData(_o.GetCurrentPathName(),V.rawStorageObj);this.isConfirmationScenario=this.ValidateOtherSellerConfirmationScenario(this.domainName,this.checkoutPageUrlData,e)}catch(e){}}GetPopupOriginationList(){return[L.AUTO_SHOW_OTHER_SELLERS]}async CanAutoOpenForFeature(e){if(!this.checkoutPageUrlData||!this.ShouldTriggerOtherSellers(this.checkoutPageUrlData))return!1;if(!Ze()&&this.validatorModule.validationMsgNum>0)return this.ValidateOtherSellersScenario(this.domainName,this.checkoutPageUrlData,this.localDataService.GetMarket(),this.isConfirmationScenario),!1;this.validatorModule.SendValidationMessage(!1,to.CheckingOtherSellers,this.domainName);const t=await this.ValidateOtherSellersScenario(this.domainName,this.checkoutPageUrlData,this.localDataService.GetMarket(),this.isConfirmationScenario);return t&&this.validatorModule.SendValidationMessage(!1,to.OtherSellers,this.domainName,[b.OTHER_SELLERS],!1,!Ze()),t}async PostValidation(){}ShouldTriggerOtherSellers(e){return void 0!==e.otherSellerSelectors&&this.IsVersionAllowed(Re,e.otherSellerSelectors.jSVersionThreshold)}isOtherSellersScenario(t){const o=t?.otherSellerSelectors?.otherSellersOverlayLinkSelector;return!(!o||e(o))&&Be.HasVisibleElement(o)}CheckOtherSellersAutoOpen(e){const t=e.otherSellerSelectors.otherSellerLowestPriceSelector,o=Be.GetFirstVisibleElement(t);if(o&&o.innerText){const o=at.GetOrderTotalString(e.orderTotalDataElementSelector),i=new bl;if(i.price=at.GetOrderTotalString(t),i.delivery="",!this.OtherSellerHasLowerPrice("amazon",o,i,""))return!1}return!0}async StoreOtherSellersInfo(e,t,o){if(!t)return null;if(!this.ValidateDataFields(e,t))return null;const i="OtherSellersData_"+_o.GetCurrentPathName(),a="OtherSellersIframe";try{const r=t.otherSellerSelectors.otherSellersOverlayLinkSelector,n=Be.GetFirstVisibleElement(r);if(n){const s=n.getAttribute("href");if(s&&e.includes("amazon")){const r=this.CreateIframe(a,s);document.body.insertBefore(r,document.body.children[0]);const n=await this.CollectOtherSellersInfo(e,t,a,o);try{this.RankOtherSellers(n)}catch(t){const o="Error while ranking other sellers. "+t,i=new Rl;i.SetResultData(e,0,Te.GetPriceStringAsNumber(n?.productPrice??""),"",n?.currency??"$","Error"),at.SendLogEventMessage(i,p.OtherSellers,this.validatorModule.impressionId,o,h.Information)}if(n&&n.otherSellers?.length>0)return at.SendStorageMessage(i,JSON.stringify({value:JSON.stringify(n)})),n}else if("walmart.com"===e){const n=this.CreateIframe(a,_o.GetCurrentPathName());document.body.appendChild(n),await me.WaitForCondition((async()=>{const e=document.querySelectorAll("#"+a)[0],t=e?.contentDocument?.body,o=t?.querySelector(r);return void 0!==o?.innerText}),13e4);const s=document.querySelectorAll("#"+a)[0],c=s?.contentDocument?.body,l=c?.querySelector(r);l&&(l.click(),await setTimeout((()=>{l.click()}),3e3));const u=await this.CollectOtherSellersInfo(e,t,a,o);if(u&&u.otherSellers?.length>0)return at.SendStorageMessage(i,JSON.stringify({value:JSON.stringify(u)})),u}}}catch(t){const o="Error while getting collecting other sellers data. "+t,i=new Rl;i.SetResultData(e,0,0,"","","Error"),at.SendLogEventMessage(i,p.OtherSellers,this.validatorModule.impressionId,o,h.Information)}return null}ResetOtherSellersNotificationFlag(){at.SendStorageMessage("OtherSellersNotificationData_"+_o.GetCurrentPathName(),JSON.stringify({value:null}))}ValidateOtherSellerConfirmationScenario(e,t,o){return!(!this.ShouldTriggerOtherSellers(t)||!this.isOtherSellersConfirmationScenario(o))&&(this.ResetOtherSellersNotificationFlag(),!0)}IsVersionAllowed(t,o){if(e(o))return!0;try{return parseFloat(t)>=parseFloat(o)}catch(e){}return!1}isOtherSellersConfirmationScenario(e){if(e?.ProductAddedNotification){if(e?.Url===_o.GetCurrentPathName())return!0;this.ResetOtherSellersNotificationFlag()}return!1}ManageOtherSellersData(t,o,i){const a="OtherSellersData_"+t;!e(i[a])&&at.DeleteKeyFromPersistentStorage(a);const r=o.replace(/[,{]"OtherSellersData_[^\s{]*":null/g,"").replace(/[,{]"OtherSellersConfirmationData_[^\s{]*":null/g,"").match(/[,{]"OtherSellersData_[^\s{]*":|[,{]"OtherSellersConfirmationData_[^\s{]*":/g);r&&r.length>20&&this.ClearOtherSellersStorage(r,i)}ClearOtherSellersStorage(t,o){if(null!==t&&null!=o)for(const i of t){const t=i.slice(2,-2);if(e(o[t])){const e="Tried to delete key that doesn't exist from persistent storage",t=new Rl;t.SetResultData(fe.GetDomainName(),0,0,"","","Error"),at.SendLogEventMessage(t,p.OtherSellers,this.validatorModule.impressionId,e,h.Information)}else at.DeleteKeyFromPersistentStorage(t)}}GetOtherSellersNotificationData(t,o){const i="OtherSellersNotificationData_"+t;return!e(o[i])?Ll.Create(fe.GetStorageObject(o[i])):new Ll}async ValidateOtherSellersScenario(e,t,o,i){if(this.isOtherSellersScenario(t)){if(i)return this.TryStoreOtherSellersInfo(e,t,o,!1),!1;if(!this.ShouldAutoShowForOtherSellers(e,V.OtherSellersAutoShowCount??0,V.OtherSellersLastAutoShowTime))return this.TryStoreOtherSellersInfo(e,t,o,!1),!1;if(e.includes("amazon")){if(!this.CheckOtherSellersAutoOpen(t))return this.TryStoreOtherSellersInfo(e,t,o,!1),!1}return await this.TryStoreOtherSellersInfo(e,t,o,!0)}return!1}async TryStoreOtherSellersInfo(e,t,o,i){const a=await this.StoreOtherSellersInfo(e,t,o),r=null!==a;if(!r)return!1;let n=!0;if("amazon.com"===e&&a&&a.otherSellers?.length>0){const e=a.otherSellers[0].heading?.toLowerCase()??"";n=e.includes("new")&&!e.includes("like")}return!!(r&&n&&i)}ShouldAutoShowForOtherSellers(t,o,i){if(e(i)||o<2)return!0;const a=this.ParseLastAutoShowTime(t,i);if(a<=0)return!0;return Date.now()-a>72e5&&(at.SendStorageMessage("OtherSellersAutoShowCount",JSON.stringify({value:null})),at.SendStorageMessage("OtherSellersLastAutoShowTime",JSON.stringify({value:null})),!0)}ParseLastAutoShowTime(e,t){try{return Date.parse(t)}catch(t){const o="Error while parsing other sellers autoshow date. "+t,i=new Rl;return i.SetResultData(e,0,0,"","","Error"),at.SendLogEventMessage(i,p.OtherSellers,this.validatorModule.impressionId,o,h.Information),0}}OtherSellerHasLowerPrice(e,t,o,i,a,r){try{const n=Te.GetPriceStringAsNumber(t);let s=Te.GetPriceStringAsNumber(o.price);const c=this.GetDeliveryRegex(e,i,r??"");let l=0;const u=o.delivery.trim().match(c);u&&u.length>0&&(l=Te.GetPriceStringAsNumber(u[0])),l>0&&(s+=l),o.totalPrice=s;const d=n-s;if(n&&s&&d>=(a??.6)&&d/n>=.01)return!0}catch(e){}return!1}GetDeliveryRegex(e,t,o){if("walmart.com"===e)return/\$[0-9.,]+/;try{const e=Te.GetStandardizedCurrency(t,o),i="^"+Te.GetEscapedCurrency(e)+"\\s*[0-9.,]+",a="[0-9.,]+\\s*"+Te.GetEscapedCurrency(e);return new RegExp(i+"|"+a)}catch(t){switch(e){case"amazon.com":return/^\$[0-9.,]+/;case"amazon.co.uk":return/^\£[0-9.,]+/;default:return/\$[0-9.,]+/}}}async CollectOtherSellersInfo(t,o,i,a){const r=new Ml;r.otherSellers=[];const n=o.otherSellerSelectors;await me.WaitForCondition((async()=>{const e=document.querySelectorAll("#"+i)[0],t=e?.contentDocument?.body,o=t?.querySelector(n.otherSellerOfferElementSelector);return void 0!==o?.innerText}),13e4);const s=document.querySelectorAll("#"+i)[0],c=s?.contentDocument?.body,l=c?.querySelectorAll(n.otherSellerOfferElementSelector);if(!l)return r;let u=at.GetOrderTotalString(o.orderTotalDataElementSelector);u?.includes("(")&&u?.includes(")")&&(u=u.slice(0,u.indexOf("("))),r.productPrice=u,r.currency=Te.ExtractCurrencyString(u);let d=0;for(const e of l){if(0===d&&"walmart.com"===t){d+=1;continue}const o=new bl,i=e.querySelector(n.otherSellerPriceSelector);o.price=i?.innerText??"",o.currency=Te.ExtractCurrencyString(i?.innerText??"");const s=e.querySelector(n.otherSellerDeliverySelector);if(o.delivery=s?.innerText??"","walmart.com"===t){const e=i?.innerText?.split("\n");if(e&&(o.price=e[0],o.currency="$",e.length>1)){const t=e[1];!t.toLowerCase().includes("free")&&o.delivery&&(o.delivery+=t)}}if(!this.OtherSellerHasLowerPrice(t,u,o,o.currency,void 0,a))break;const c=e.querySelector(n.otherSellerHeadingSelector),l=e.querySelector(n.otherSellerNameSelector),C=e.querySelector(n.otherSellerRatingSelector),h=/a-star-mini-([0-9\-]+)/.test(C?.className)?RegExp.$1:"-1";o.heading=c?.innerText,o.soldBy=l?.innerText,o.sellerUrl=l?.getAttribute("href")??"","-1"!==h&&(o.rating=parseFloat(h.replace("-","."))),o.index=d,r.otherSellers.push(o),d+=1}const C=c?.querySelector(n.productImageSelector);return C&&!e(C.src)&&(r.productImage=C.src),r.productUrl=_o.GetCurrentPathName(),r.dataCreationTime=Date.now(),r}ValidateDataFields(e,t){const o=t.otherSellerSelectors;if(void 0===o)return!1;const i=me.IsValidDataField(o.otherSellersOverlayLinkSelector)&&me.IsValidDataField(o.otherSellerOfferElementSelector)&&me.IsValidDataField(o.otherSellerHeadingSelector)&&me.IsValidDataField(o.otherSellerPriceSelector)&&me.IsValidDataField(o.otherSellerDeliverySelector)&&me.IsValidDataField(o.productImageSelector)&&me.IsValidDataField(o.otherSellerNameSelector)&&me.IsValidDataField(o.otherSellerAddButtonSelector)&&me.IsValidDataField(o.otherSellerAddedConfirmationSelector),a=me.IsValidDataField(o.otherSellerRatingSelector),r=me.IsValidDataField(t.errorMessageSelector);if(e.includes("amazon"))return i&&a;if("walmart.com"===e)return i&&r;{const t="Other sellers scenario for wrong domain: "+e,o=new Rl;return o.SetResultData(e,0,0,"","","Error"),at.SendLogEventMessage(o,p.OtherSellers,this.validatorModule.impressionId,t,h.Information),!1}}CreateIframe(e,t){const o=document.createElement("iframe");return o.id=e,o.src=t,o.style.position="absolute",o.style.width="0",o.style.height="0",o.style.border="none",o.style.visibility="hidden",o.style.left="0",o.style.top="0",o.hidden=!0,o.tabIndex=-1,o.title="empty",o.style.display="none",o}RankOtherSellers(e){const t=[],o=[];for(const i of e.otherSellers){let a=!1;if(i.heading?.toLowerCase().includes("new")){const t=i.totalPrice,o=Te.GetPriceStringAsNumber(e.productPrice);let r=1;i.heading?.toLowerCase().includes("like new")&&(r=3),o-t>=r&&(a=!0)}a?t.push(i):o.push(i)}return e.otherSellers=t.concat(o),e}};var Fl=class{constructor(e){if(a(this,"maxPrice",void 0),a(this,"minPrice",void 0),a(this,"avgPrice",void 0),a(this,"numberOfVehicles",void 0),a(this,"cumulativePricePosition",void 0),a(this,"buckets",void 0),a(this,"currency",void 0),a(this,"validData",!1),a(this,"make",void 0),a(this,"model",void 0),a(this,"year",void 0),a(this,"price",void 0),e){const t=e.maxPrice,o=e.minPrice,i=e.avgPrice,a=e.numberOfVehicles,r=e.currency,n=e.buckets;if(!n&&0===n.length)return;if(!(t&&i&&o&&r&&a))return;this.maxPrice=Math.round(t),this.minPrice=Math.round(o),this.avgPrice=Math.round(i),this.numberOfVehicles=a,this.currency=r,this.cumulativePricePosition=e.cumePricePosition,this.buckets=e.buckets,this.make=e.make,this.model=e.model,this.year=e?.year,this.price=e?.price,this.validData=void 0!==this.price&&void 0!==this.model&&void 0!==this.year&&void 0!==this.avgPrice}}};var Bl=class{constructor(e){a(this,"year",void 0),a(this,"make",void 0),a(this,"model",void 0),a(this,"isValid",!1),e&&(this.make=e.make,this.model=e.model,this.year=e.year,this.isValid=void 0!==this.make&&void 0!==this.model&&void 0!==this.year)}};let Hl=function(e){return e.AutosOemPriceInsightString="AutosOemPriceInsight_",e.AutosOemMarketplaceString="AutosOemMarketplace_",e.AutosOemReviewString="AutosOemReviewString_",e.AutosSerpPriceInsightString="AutosSerpPriceInsight_",e.AutosSerpMarketplaceString="AutosSerpMarketplace_",e.AutosSerpReviewString="AutosSerpReview_",e.AutosMarketplaceString="AutosMarketplace_",e.AutosPriceInsightString="AutosPriceInsight_",e.AutosReviewString="AutosReview_",e.AutosMyGarageString="MyGarage_",e.AutosGlobalCoolDownString="AutosLastNotification",e}({});var Gl=class{SendMessage(e,t){at.SendMessage(e,t)}SendStringStorageMessage(e,t){at.SendStringStorageMessage(e,t)}SendBoolStorageMessage(e,t){at.SendStorageMessage(e,JSON.stringify({value:t}))}};class xl{constructor(){a(this,"lastUrl",""),a(this,"validationMessageService",new Gl)}InvokeOEMScenario(e,t,o){const i=this.ExtractVehicleDetails(o?.autosDataSelector);if(this.isAutosCommunityDomain(e)){!0!==this.autosCommunityDomainIgnoreVehicleDetails(e)&&null==i||this.InvokeSERPScenario(t?.retailerData?.domainName,i)}else!0===t?.autos?.isAutosSupportedDomain&&this.InvokeSERPScenario(t?.retailerData?.domainName,i)}processCashBackResponseForAutosMarketplace(e){const t={};t.autosData=e,t.currentUrl=fe.GetPageUrl();const o=JSON.stringify(t),i=fe.GetDomainName();this.validationMessageService.SendStringStorageMessage(x.AutosMarketplace,o),this.updateAddressBar();const a=nd.GetValidatorModule();if(this.isLastNotificationInsideCooldownPeriod())return;const r=this.CanMyGarageAutoShow(e?.vehicleInfo);if(r&&this.CanMyGarageAutoShowFirst(e?.vehicleInfo)&&this.passCheckAutoShowInStorage(Hl.AutosMyGarageString))return this.updateNotificationModuleToStorage(te.MYGARAGE),a.SendValidationMessage(!1,to.AutosMarketplace,i,[b.AUTOS_MARKETPLACE],!1,!Ze()),void this.AddGlobalCoolDownSignal();e?.shouldAutoshow&&this.canComparableOffersAutoshow(e?.comparableOffers)&&this.passCheckAutoShowInStorage(Hl.AutosMarketplaceString)?(this.updateNotificationModuleToStorage(te.LISTING),a.SendValidationMessage(Ze(),to.AutosMarketplace,t.currentUrl,[b.AUTOS_MARKETPLACE]),this.AddGlobalCoolDownSignal()):r&&this.passCheckAutoShowInStorage(Hl.AutosMyGarageString)?(this.updateNotificationModuleToStorage(te.MYGARAGE),a.SendValidationMessage(!1,to.AutosMarketplace,i,[b.AUTOS_MARKETPLACE],!1,!Ze()),this.AddGlobalCoolDownSignal()):e?.shouldAutoshow&&this.canReviewsAutoShow(e?.ratingReview)&&this.passCheckAutoShowInStorage(Hl.AutosReviewString)?(this.updateNotificationModuleToStorage(te.REVIEW),a.SendValidationMessage(Ze(),to.AutosMarketplace,t.currentUrl,[b.AUTOS_MARKETPLACE]),this.AddGlobalCoolDownSignal()):e?.shouldAutoshow&&this.CanPriceInsightsAutoShow(e?.priceInsights)&&this.passCheckAutoShowInStorage(Hl.AutosPriceInsightString)&&(this.updateNotificationModuleToStorage(te.PRICEINSIGHT),a.SendValidationMessage(Ze(),to.AutosMarketplace,t.currentUrl,[b.AUTOS_MARKETPLACE]),this.AddGlobalCoolDownSignal())}canComparableOffersAutoshow(e){if(e&&e?.length>0){let t=!1;return e.forEach((e=>{e&&e?.offerLevelSignals&&"true"===e?.offerLevelSignals?.autoshow&&(t=!0)})),t}return!1}canReviewsAutoShow(e){return void 0!==e&&e.videoReviews?.reviews?.length>0}passCheckAutoShowInStorage(e,t){const o=e+t,i=de(o);if(null==i)return ge(o,(new Date).toString()),!0;try{const e=144e5,t=new Date,o=new Date(i);if(t.getTime()-o.getTime()<e)return!1}catch{}return ge(o,(new Date).toString()),!0}AddGlobalCoolDownSignal(){ge(Hl.AutosGlobalCoolDownString,(new Date).toString())}isLastNotificationInsideCooldownPeriod(){const e=de(Hl.AutosGlobalCoolDownString);if(null==e)return!1;try{const t=3e5,o=new Date,i=new Date(e);if(o.getTime()-i.getTime()<t)return!0}catch{return!1}return!1}updateNotificationModuleToStorage(e){this.validationMessageService.SendStringStorageMessage(x.AutosMarketplaceNotification,e)}InvokeSERPScenario(e,t){if(this.lastUrl===fe.GetPageUrl())return;this.lastUrl=fe.GetPageUrl();const o=[];o.push({keyword:""});const i={domainName:e,queries:o,autosQuery:{url:fe.GetPageUrl(),vehicleDetails:t,title:fe.GetPageTitle()},queryType:"search"};at.SendMessage(Pe.GetCashBack,[JSON.stringify(i)])}CanPriceInsightsAutoShow(e){const t=new Fl(e);return t?.validData}CanMyGarageAutoShow(e){if(!c.isExperimentActive(t.autosMyGarageEntryPoint)&&!c.isExperimentActive(t.autosMyGarageEntryPointV2))return!1;const o=new Bl(e);return o?.isValid}CanMyGarageAutoShowFirst(e){if(!c.isExperimentActive(t.autosMyGarageEntryPoint))return!1;const o=new Bl(e);return o?.isValid}ExtractVehicleDetails(e){let t=null;try{if(void 0===e)return t;const o=JSON.parse(e),i=o?.Make||o?.ratingReview?.metaData?.make,a=o?.Model||o?.ratingReview?.metaData?.model,r=o?.Year;return null===i&&null===a&&null===r?null:(t={Make:i,Model:a,Year:r},t)}catch(e){return t}}isAutosCommunityDomain(e){return null!=e&&xl.CommunityDomains.has(e)}autosCommunityDomainIgnoreVehicleDetails(e){if(null==e)return!1;return!0===xl.CommunityDomains.get(e)}updateAddressBar(){(new Gl).SendMessage(Pe.UpdateAddressBar,[JSON.stringify({type:"AutosMarketplaceOffers"})])}}a(xl,"CommunityDomains",new Map([["reddit.com",!1],["motortrend.com",!0]]));var Vl=xl;const Kl=new class extends He{initializeRuntime(e){"complete"===document.readyState?window.IsConfirmationPageValid(e,!1):window.addEventListener&&window.addEventListener("load",(t=>{window.CheckAndIsConfirmationPageValid(e,!1)}))}handleMessages(e,t){if("ConfirmationPageValidation"===t)try{"complete"===document.readyState?window.IsConfirmationPageValid(e,!0):window.addEventListener&&window.addEventListener("load",(t=>{window.CheckAndIsConfirmationPageValid(e,!0)}))}catch(e){}}getNativeHandler(){return confirmationPageValidatorNativeHandler}};var Wl=class{isCancellationPageValid(e){if(e.cancellationPageTelemetry?.cancellationPageUrlRegex&&""!==e.cancellationPageTelemetry.cancellationPageUrlRegex){return new RegExp(e.cancellationPageTelemetry.cancellationPageUrlRegex,"i").test(fe.GetPageUrl())}return!1}GetAndSendCancellationPageData(e,t){let o="";e?.cancellationPageTelemetry?.transactionIdSelector&&""!==e?.cancellationPageTelemetry?.transactionIdSelector&&(o=at.GetBoxValue(e.cancellationPageTelemetry.transactionIdSelector));let i="";e?.cancellationPageTelemetry?.totalPriceSelector&&""!==e?.cancellationPageTelemetry?.totalPriceSelector&&(i=at.GetBoxValue(e.cancellationPageTelemetry.totalPriceSelector));let a="";e?.cancellationPageTelemetry?.cancellationTextSelector&&""!==e?.cancellationPageTelemetry?.cancellationTextSelector&&(a=at.GetBoxValue(e.cancellationPageTelemetry.cancellationTextSelector));let r="",n="";if(e?.cancellationPageTelemetry?.productTitleSelector&&""!==e?.cancellationPageTelemetry?.productTitleSelector){const t=Be.RunQuerySelectorAll(e?.cancellationPageTelemetry?.productTitleSelector);if(t.length>0)for(const e of t)e&&e.textContent&&(r+=e.textContent?.trim()+"<SEP>")}let s="";if(e?.cancellationPageTelemetry?.pricePerItemSelector&&""!==e?.cancellationPageTelemetry?.pricePerItemSelector){const t=Be.RunQuerySelectorAll(e?.cancellationPageTelemetry?.pricePerItemSelector);if(t.length>0)for(const e of t)e&&e.textContent&&(s+=e.textContent?.trim()+"<SEP>")}if(e?.cancellationPageTelemetry?.productQuantitySelector&&""!==e?.cancellationPageTelemetry?.productQuantitySelector){const t=Be.RunQuerySelectorAll(e?.cancellationPageTelemetry?.productQuantitySelector);if(t.length>0)for(const e of t)e&&e.textContent&&(n+=e.textContent?.trim()+"<SEP>")}const c={CancellationPageUrl:fe.GetPageUrl(),Domain:fe.GetDomainName(),TransactionId:o,CancellationPageText:a,ProductNames:r,QuantityPerItem:n,PricePerItem:s,TotalPrice:i},l={};l.JsonData=JSON.stringify(c),l.EventType="CancellationPageDetails",l.LogLevel="Information",l.Message="Cancellation Page Details",l.ClientContext={AppInfoClientName:G.GetClientName(),JSVersion:ye},t&&(l.ImpressionId=t);const u=[JSON.stringify(l)];Kl.postMessageToHost("LogScriptTelemetry",u)}};var zl=class{static IsOnCheckoutPage(e,t){return!(!t||!t.retailerData)&&t.retailerData.UpdateCurrentCheckoutPage(e)}static getQuantity(e,t){const o=t.querySelector(e),i=o?.innerText?.trim();let a=Number(i);try{if(isNaN(a)||0===a){if(["select","input"].includes(o?.nodeName.toLowerCase())){const o=t.querySelector(e);a=Number(o.value)}else{const e=/[-]{0,1}[\d]*[.]{0,1}[\d]+/g,t=o?.innerText?.trim().match(e);t&&t?.length>0&&(a=Number(t[0]))}}}catch(e){a=-1}return isNaN(a)&&(a=-1),a}static isElementDisabled(e){return"disabled"===e.getAttribute("disabled")}};class Yl{}a(Yl,"ProductIdsGetter",{"amazon.com":e=>{const t=document.querySelectorAll(e);if(t){let e="";return t.forEach((t=>{const o=t.defaultValue.split("|")[0];e+=o+Yl.sep})),e}return null},"walmart.com":e=>{const t=document.querySelector(e);if(t){const e=t?.src,o=/item_ids=([^&]*)/,i=e?.match(o);let a="";if(i&&i.length>=2){i[1].split("%2C").forEach((e=>{a+=e+Yl.sep}))}return a}return null},"jcpenney.com":e=>{const t=document.querySelectorAll(e);if(t){let e="";return t.forEach((t=>{const o=t.dataset.ppid;e+=o+Yl.sep})),e}return null}}),a(Yl,"sep","<SEP>");var Jl=Yl;class jl{constructor(){a(this,"name",void 0),a(this,"startDate",void 0),a(this,"endDate",void 0)}static Create(e){const t=new jl;return t.name=e.name,t.startDate=e.startDate,t.endDate=e.endDate,t}}var Xl=jl;class Zl{constructor(){a(this,"checkoutUrl",void 0),a(this,"domain",void 0),a(this,"domainType",void 0),a(this,"checkoutId",void 0),a(this,"startDate",void 0),a(this,"endDate",void 0),a(this,"name",void 0),a(this,"currency",void 0),a(this,"price",void 0),a(this,"flightLegs",void 0),a(this,"isRoundTrip",void 0)}static Create(e){const t=new Zl;return t.domain=e.domain,t.price=e.price,t.currency=e.currency,t.checkoutUrl=e.checkoutUrl,t.domainType=e.domainType,t.startDate=e.startDate,t.endDate=e.endDate,e.flightLegs?.forEach((e=>{t.flightLegs.push(Xl.Create(e))})),t}}var $l=Zl;const ql="TravelDataStorageInfo";class Ql{constructor(){a(this,"Price",void 0),a(this,"TravelDataCreationTime",void 0),a(this,"CheckoutId",void 0),a(this,"StartDate",void 0),a(this,"EndDate",void 0),a(this,"Currency",void 0),a(this,"Name",void 0),a(this,"DomainType",void 0),a(this,"flightLegs",void 0),a(this,"isRoundTrip",void 0),a(this,"PageUrl",void 0)}}function eu(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,i)}return o}function tu(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?eu(Object(o),!0).forEach((function(t){a(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):eu(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}var ou=class{constructor(e){a(this,"automaticCEService",void 0),a(this,"cartExtractionSuccessful",void 0),a(this,"mutationObserver",void 0),a(this,"isPersonalizationDataConsentEnabled",void 0),a(this,"onCartExtractionCallback",void 0),this.automaticCEService=e}subscribe(e){this.onCartExtractionCallback=e}async Init(){const e=nd.GetLocalDataService(),t=e.GetCheckoutPageData();if(this.isPersonalizationDataConsentEnabled=t.userInfo?.isPersonalizationDataConsentEnabled??e.IsP13nEnabled()??!1,!t.retailerData)return;const o=e.GetIsFinalCheckoutPage(),i=fe.GetMarket(t?.market,t.retailerData?.exclusiveMarket),a=e.GetImpressionId(),r=e.GetDomainName(),n=t?.retailerData?.cartMonitorUrl,s=t.retailerData.getCurrentFinalCheckoutPage(),c=t?.retailerData?.storeCartInEdgeStorage||!1,l=e.GetIsAOCActive(),u=t.retailerData.getCurrentAutomatedSelectorsPage(location.href);o&&this.TryCheckAndCollectCartInformation(r,a,s,i,l,u,!1,t.isCashbackEstimationSupportedForDomain,c,n);const d=this.ShouldAddCartButtonListener(t.retailerData.getCurrentCheckoutPage(),r);d.shouldAddListener&&d.cartButtonSelector&&this.AddCartButtonListener(d.cartButtonSelector,location.pathname,t,r,a,i,t,c,n,l,u);const C=t.retailerData?.getCurrentCheckoutPage(location.pathname);if(!C)return;const h=C.pageType??I.CheckoutPage;h===I.CheckoutPage&&(o?this.TryShouldAttemptCartCollectionAgain(r,a,C,i,l,u,C?.automatedCartExtractionEnabled,t.isCashbackEstimationSupportedForDomain,c):this.TryCheckAndCollectCartInformation(r,a,C,i,l,u,C?.automatedCartExtractionEnabled,t.isCashbackEstimationSupportedForDomain,c,n)),h===I.ProductPage&&this.CollectCartInfoFromProductPage(r,t,a,i,l,u,c,n)}async PostValidation(){}async TryShouldAttemptCartCollectionAgain(e,t,o,i,a,r,n,s,c,l){this.ShouldAttemptCartCollectionAgain(o,n).then((u=>{u&&this.TryCheckAndCollectCartInformation(e,t,o,i,a,r,n,s,c,l)})).catch((o=>{const i={domain:e,cartUrl:location.pathname};this.LogCartExtractionEvent(i,p.CartExtractionError,o?.message,h.Error,t)}))}async ShouldAttemptCartCollectionAgain(e,t){return e&&(e?.cartSelectors||!0===t||e?.travelCheckoutSelectors)?(await me.WaitForCondition((async()=>void 0!==this.cartExtractionSuccessful),3e4),!0!==this.cartExtractionSuccessful):(this.notifyCartDataListeners(),!1)}async TryCheckAndCollectCartInformation(e,t,o,i,a,r,n,s,c,l,u){o?.travelCheckoutSelectors&&this.CheckAndCollectTravelCheckoutInformation(e,t,o.travelCheckoutSelectors,i,c).catch((e=>{})),this.CheckAndCollectCartInformation(e,t,o,i,a,r,n,s,c,l,u,o?.getProductNamesFromImg).catch((o=>{const i={domain:e,cartUrl:location.pathname};this.LogCartExtractionEvent(i,p.CartExtractionError,o?.message,h.Error,t)}))}GetLastTravelData(){const t=de(ql);return t&&!e(t)?JSON.parse(t):null}async GetLastCartBlockedCoupons(){await me.WaitForCondition((async()=>!0!==this.GetBlockedCouponsRequestPending()),15e3,1e3);const e=this.GetLastCartData();return e&&e?.BlockedCoupons?.length>0?e.BlockedCoupons:[]}GetLastCartExtractionId(){const e=this.GetLastCartData();if(e&&e?.ExtractionId?.length>0)return e.ExtractionId}GetLastCartData(){const t=de(Bt);return t&&!e(t)?JSON.parse(t):null}GetAvailableCartData(){const t=this.GetLastCartData(),o=de(Ht);let i=null;o&&!e(o)&&(i=JSON.parse(o));const a=i?.CartDataCreationTime??0;return t?.CartDataCreationTime&&t?.CartDataCreationTime>a?t:i}async CheckAndCollectCartInformation(e,t,o,i,a,r,n,s,c,l,u,d){if(!o||!o?.cartSelectors&&!0!==n&&!r?.details?.productName){this.cartExtractionSuccessful=!1;const o="Unable to get cart data: No Selectors",i={cartId:"",cartUrl:location.pathname,domain:e};return"rei.com"===e&&(i.cartUrl=location.pathname+location.hash),void this.LogCartExtractionEvent(i,p.CartExtractionError,o,h.Error,t)}const C=o?.pageType===I.ProductPage,g=this.GetLastCartData(),S=o.orderTotalDataElementSelector;let O={OrderTotal:-1,Currency:Te.GetCurrencyFromMarket(i)??"",PageCurrency:""};me.IsValidDataField(S)&&(O=await me.WaitForCondition((async()=>Be.RunQuerySelectorAll(S)?.length>0),5e3).then((async()=>await To.WaitAndGetCartValue(S,i))).catch((o=>{const i={cartId:g?.CartId??"",cartUrl:location.pathname,domain:e};return this.LogCartExtractionEvent(i,p.CartExtractionError,o?.message,h.Error,t),O}))),O.OrderTotal>0||(O=await To.WaitAndGetCartValue2(S,i));try{const u=new URL(window.location.href);l&&this.MonitorCart(e,t,u,o,i,a,r,n,s,c,l)}catch(e){}if(g&&!this.ShouldCollectStorageData(O,g))return void this.notifyCartDataListeners();if(!o?.cartSelectors&&!r?.details?.productName)return void this.automaticCEService.TryCollectCartInformation(e,O,i,t,li.traceId,a,g?.CartId);const A=o.cartSelectors;try{await this.CollectCartInformation(e,O,A,t,o,a,i,r,g?.CartId,c,C,u,d)}catch(o){const i={cartId:g?.CartId??"",cartUrl:location.pathname,domain:e};"rei.com"===e&&(i.cartUrl=location.pathname+location.hash),this.LogCartExtractionEvent(i,p.CartExtractionError,o?.message,h.Error,t)}}async TryCheckAndCollectTravelCheckoutInformation(e,t,o,i){this.CheckAndCollectTravelCheckoutInformation(e,t,o,i).catch((e=>{}))}async CheckAndCollectTravelCheckoutInformation(e,t,o,i,a){if(!o)return;const r=this.GetLastTravelData(),n=o.priceSelector;let s={OrderTotal:-1,Currency:"$",PageCurrency:""};if(me.IsValidDataField(n)&&(s=await me.WaitForCondition((async()=>Be.RunQuerySelectorAll(n)?.length>0),5e3).then((async()=>await To.WaitAndGetCartValue2(n,i))).catch((o=>{const i={cartId:r?.CheckoutId??"",cartUrl:location.pathname,domain:e};return this.LogCartExtractionEvent(i,p.CartExtractionError,o?.message,h.Error,t),s}))),!r||this.ShouldCollectTravelStorageData(s,r))try{await this.CollectTravelCheckoutInformation(e,t,o,r?.CheckoutId,a)}catch(o){const i={cartId:r?.CheckoutId??"",cartUrl:location.pathname,domain:e};return this.LogCartExtractionEvent(i,p.CartExtractionError,o?.message,h.Error,t),s}}ShouldCollectTravelStorageData(t,o){if(o&&o.Price===t.OrderTotal&&-1!==t.OrderTotal&&!e(o.CheckoutId)){if(Date.now()-o.TravelDataCreationTime<=432e5)return!1}return!0}async CollectTravelCheckoutInformation(e,t,o,i,a){const r=new $l;let n;if(r.domain=e,r.domainType=o.domainType,r.checkoutId=i??K.uuidv4(),r.checkoutUrl=location.pathname,await me.WaitForCondition((async()=>(n=Be.GetFirstVisibleElement(o.startDateSelector),void 0!==n)),5e3),void 0===n){return}r.flightLegs=[];const s=Be.GetAllVisibleElements(o.startDateSelector),c=Be.GetAllVisibleElements(o.endDateSelector),l=Be.GetAllVisibleElements(o.nameSelector);if(s.length>1)for(let e=0;e<s.length;e++){const t=new Xl;t.startDate=s[e].innerText?.trim()??"",e<c.length&&(t.endDate=c[e].innerText?.trim()??""),e<l.length&&(t.name=l[e].innerText?.trim()??""),r.flightLegs.push(t)}r.startDate=n?.innerText?.trim();const u=Be.GetFirstVisibleElement(o.endDateSelector),d=Be.GetFirstVisibleElement(o.nameSelector);r.endDate=u?.innerText?.trim()??"",r.name=d?.innerText?.trim()??"";const C=at.GetOrderTotalString(o.priceSelector),g=Te.ExtractCurrencyString(C),S=Te.GetPriceStringAsNumber(C);r.price=S,r.currency=g;this.LogCartExtractionEvent(r,p.TravelCheckoutExtraction,"Successfully extracted Travel Checkout Information",h.Information,t);const O=new Ql;O.Price=r.price,O.CheckoutId=r.checkoutId,O.StartDate=r.startDate,O.EndDate=r.endDate,O.Name=r.name,O.DomainType=r.domainType,O.Currency=r.currency,O.TravelDataCreationTime=Date.now(),O.PageUrl=location.pathname,ge(ql,JSON.stringify(O)),a&&this.SendPersistentTravelCheckoutMessage(e,O,t)}async MonitorCart(e,t,o,i,a,r,n,s,c,l,u){if(u===o.pathname||c){const s={attributes:!0,characterData:!0,childList:!0,subtree:!0};this.mutationObserver||(this.mutationObserver=new MutationObserver((async o=>{this.CheckAndCollectCartInformation(e,t,i,a,r,n,i?.automatedCartExtractionEnabled,c,l,u,i?.getProductNamesFromImg),window.dispatchEvent(new Event("CartUpdate"))})));const d=i?.orderTotalDataElementSelector,C=i?.orderTotalDataContainerElementSelector;if(d){await me.WaitForCondition((async()=>{const e=Be.GetFirstVisibleElement(d);return void 0!==e?.innerText}),5e3);const e=Be.GetFirstVisibleElement(d);if(e&&(this.mutationObserver?.disconnect(),this.mutationObserver?.observe(e,s),C)){const e=Be.GetFirstVisibleElement(C);e&&this.mutationObserver?.observe(e,s)}}if("kohls.com"===e&&"/checkout/shopping_cart.jsp"===o.pathname){const e="shoppingBagHook",t=document.getElementById(e);t&&this.mutationObserver?.observe(t,s)}else if("bedbathandbeyond.com"===e&&"/store/checkout"===o.pathname){const e="ul[class*='ProgressBar']",t=Be.GetFirstVisibleElement(e);t&&(this.mutationObserver?.disconnect(),this.mutationObserver?.observe(t,s))}else if("macys.com"===e&&o.pathname===u){const e="bag-summary",t=document.getElementById(e);t&&this.mutationObserver?.observe(t,s)}else if("rei.com"===e&&o.pathname===u){const e=Be.GetFirstVisibleElement("section-navigation");e&&this.mutationObserver?.observe(e,s)}}else this.mutationObserver?.disconnect()}ShouldCollectStorageData(t,o){if(o&&o.OrderTotal===t.OrderTotal&&-1!==t.OrderTotal&&!e(o.CartId)){if(Date.now()-o.CartDataCreationTime<=Gt)return this.cartExtractionSuccessful=!0,!1}return!0}async GetProductNamesDirectly(e,t,o,i,a,r,n,s,c,l){let u;if(await me.WaitForCondition((async()=>(u=this.QueryAllWithAutomatedFallback(document,o?.productTitleSelector,n?.details?.productName,t,i,!1),void 0!==u&&u.length>0)),5e3),u=this.QueryAllWithAutomatedFallback(document,o?.productTitleSelector,n?.details?.productName,t,i,!0),u&&u.length>0){for(const t of u){const o=new Kt;o.productTitle=t?.textContent?.trim()??"",e.products.push(o)}this.LogCartInfo(e,t,i,a,r,s,c,l)}else{const t="No cart selector provided, unable to find products with product title selector.";this.LogCartExtractionEvent(e,p.CartExtractionError,t,h.Error,i)}}QueryWithAutomatedFallback(e,t,o,i,a){const r=this.QueryAllWithAutomatedFallback(e,t,o,i,a,e===document);return r&&r.length>0?r[0]:void 0}QueryAllWithAutomatedFallback(e,t,o,i,a,r){const n=t?e.querySelectorAll(t):void 0,s=o?e.querySelectorAll(o):void 0;if(r&&t&&o){const e={Domain:i,PageUrl:location.href,ManualSelector:t,AutomatedSelector:o,ManualMatchCount:n?.length??0,AutomatedMatchCount:s?.length??0},r="QueryAll with automated fallback";this.LogCartExtractionEvent(e,p.AutomatedSelectorsDiagnostic,r,h.Information,a,void 0,!0)}return n??s}async CollectCartInformation(o,i,a,r,n,s,l,u,d,C,g,S,O){const A=new zt;A.domain=o,A.cartValue=i.OrderTotal,A.currency=i.Currency,A.cartUrl=location.pathname,A.cartId=d??K.uuidv4(),A.products=[],"rei.com"===o&&(A.cartUrl=location.pathname+location.hash),!a||"amazon.com"!==o&&"walmart.com"!==o&&"jcpenney.com"!==o||(A.productIds=Jl.ProductIdsGetter[o](a.productIdSkuSelector));const m=c.isExperimentActive(t.cartExtractionFromBody);if(!(a?.cartSelector||e(a?.productTitleSelector??"")&&e(u?.details?.productName??"")))return this.GetProductNamesDirectly(A,o,a,r,n,l,u,C,g,S),void this.notifyCartDataListeners();if(!a||!a.cartSelector||!a.productSelector){const e="Unable to find cart, no cartSelector and no title/name selector provided.";return void this.LogCartExtractionEvent(A,p.CartExtractionError,e,h.Error,r)}let T,_;if(await me.WaitForCondition((async()=>(T=Be.GetFirstVisibleElement(a.cartSelector),void 0!==T)),5e3),void 0===T){if(!m){const e="Unable to find cart";return void this.LogCartExtractionEvent(A,p.CartExtractionError,e,h.Error,r)}{const e="Unable to find cart, using document body as fallback";this.LogCartExtractionEvent(A,p.CartExtractionError,e,h.Error,r),T=document.body}}if(await me.WaitForCondition((async()=>(_=T?.querySelectorAll(a.productSelector),void 0!==_&&_.length>0)),"bedbathandbeyond.com"===o?1e4:5e3),"bedbathandbeyond.com"===o||"target.com"===o||"cvs.com"===o){let e;await me.WaitForCondition((async()=>(e=T?.querySelectorAll(a.productTitleSelector),void 0!==e&&e.length>0&&e.length===_?.length)),1e4),_=T?.querySelectorAll(a.productSelector)}if("walmart.com"===o){const e=this.CollectProductInformationFromCollapsedCart(n,T);A.products.push(...e)}const f=this.GetLastCartData(),E=void 0!==f?.Products?.find((e=>!e.productTitle||""===e.productTitle));if("walmart.com"===o&&(void 0===_||_.length<=0)&&(null==f||null!=f&&E)){const e=T?.querySelectorAll(a.productImageSelector);if(void 0!==e&&e.length>0)for(const t of e){const e=t.getAttribute("alt");if(e){const o=new Kt;o.productTitle=e.trim(),o.productImg=t?.src??"",A.products.push(o)}}else if(A.products.length<=0){const e="Unable to find products in cart by product image";return void this.LogCartExtractionEvent(A,p.CartExtractionError,e,h.Error,r)}}else if((void 0===_||_.length<=0)&&A.products.length<=0){const t="Unable to find products in cart";return this.LogCartExtractionEvent(A,p.CartExtractionError,t,h.Error,r),void(!m||e(a?.productTitleSelector??"")&&e(u?.details?.productName??"")||this.GetProductNamesDirectly(A,o,a,r,n,l,u,C,g,S))}if(_&&_.length>0)for(const e of _){const t=await this.CollectProductInfo(e,a,u,o,r,O);if(null!=t)g&&!S&&(t.buyNowItem=!0),A.products.push(t);else{const e="Could not extract product info";this.LogCartExtractionEvent(A,p.CartExtractionError,e,h.Error,r)}}this.saveNonAugmentedCart(A),await this.automaticCEService.augmentWithWebAssist(A.products,o,li.traceId,s),this.LogCartInfo(A,o,r,n,l,C,g,S),"amazon.com"===o||n?.pageType&&n?.pageType!==I.CheckoutPage||this.CheckAndSendCartProcessingRequest(A,o)}async saveNonAugmentedCart(e){const t=new xt;t.OrderTotal=e.cartValue,t.CartDataCreationTime=Date.now(),t.CartId=e.cartId,t.ProductIds=e.productIds,t.Products=e.products,ge(Ht,JSON.stringify(t)),this.notifyCartDataListeners()}async CheckAndSendCartProcessingRequest(e,t){if(e.products.length>0){const o=nd.GetLocalDataService().GetMuid();this.SetBlockedCouponsRequestPending(!0);const i=await this.SendBlockedCouponsRequest(o,t,e);i.length>0&&this.ProcessBlockedCoupons(i,e),this.SetBlockedCouponsRequestPending(!1)}}async SendBlockedCouponsRequest(e,o,i){if(e&&e.length>0&&o&&o.length>0)try{const a={muid:e,domain:o},r=i.products.filter((e=>e.productTitle&&e.productTitle.length>0)).map((e=>e.productTitle));if(a.productNames=r.slice(0,10),c.isExperimentActive(t.clientRequests)){const e=nd.GetClientRequestsService(),t=await e.SendRequest("cartProcessing","getBlockedCoupons",a);if(t.couponCodes?.length>0)return t.couponCodes}else{const e={body:JSON.stringify(a),headers:{"Content-Type":"application/json"},method:"POST"},t="https://www.bing.com/api/shopping/v1/savings/cartProcessing/getBlockedCoupons",o=await fetch(t,e),i=await o.json();if(i?.couponCodes?.length>0)return i.couponCodes}}catch(e){}return[]}ProcessBlockedCoupons(e,t){const o=this.GetLastCartData();o&&(o.BlockedCoupons=e,ge(Bt,JSON.stringify(o)))}SetBlockedCouponsRequestPending(e){ge("blockedCouponsRequestPending",e.toString())}GetBlockedCouponsRequestPending(){return"true"===de("blockedCouponsRequestPending")}CartProductNameResolution(e,t,o){try{let i=!1;for(const e of t.products)if(void 0===e.productTitle||""===e.productTitle){i=!0;break}if(!i)return{cartInfo:t,message:"products from current cart used"};if(o?.Products){i=!1;for(const e of o.Products)if(void 0===e.productTitle||""===e.productTitle){i=!0;break}if(!i)return t.products=o.Products,{cartInfo:t,message:"products from last cached cart used"}}const a=V?.PersistentCartData,r=(fe.GetStorageObject(a)??{})[e]??{},n=r?.cartDataStorageInfo??{};if(n?.Products){i=!1;for(const e of n.Products)if(void 0===e.productTitle||""===e.productTitle){i=!0;break}if(!i)return t.products=n.Products,{cartInfo:t,message:"products from persistent cart used"}}for(const e of t.products)if(void 0===e.productTitle||""===e.productTitle){let t=this.FindProductByUrl(e.productUrl,e.productImg,o);null==t&&(t=this.FindProductByUrl(e.productUrl,e.productImg,n)),t&&(e.productTitle=t.productTitle,void 0===e.productQuantity&&(e.productQuantity=t.productQuantity))}}catch(e){return{cartInfo:t,message:"error getting products from cache or persistent cart: "+e}}return{cartInfo:t,message:"could not get products from cache or persistent cart"}}FindProductByUrl(e,t,o){if(!o?.Products)return null;for(const i of o.Products)if((i.productUrl===e||i.productImg===t)&&i.productTitle&&""!==i.productTitle)return i;return null}CollectProductInfo(t,o,i,a,r,n){const s=this.QueryWithAutomatedFallback(t,o.productTitleSelector,i?.details?.productName,a,r),c=t.querySelector(o.productUrlSelector),l=t.querySelector(o.productImageSelector),u=t.querySelector(o.productSellerSelector);let d=s?.innerText?.trim();const C=at.GetOrderTotalString(o.productPriceSelector,t),h=Te.GetPriceStringAsNumber(C)??-1,p=zl.getQuantity(o.productQuantitySelector,t);let g=u?.innerText?.trim();const S=l?.src??"",O=c?.getAttribute("href")??"";if(g&&me.IsValidDataField(o.productSellerRegex)&&(g=g.replace(o.productSellerRegex,"")),("walmart.com"===a||"target.com"===a||"jcpenney.com"===a||n)&&e(d)){const e=l?.getAttribute("alt");e&&(d=e.trim())}if(e(d)&&e(O)&&e(S))return null;const A=new Kt;return A.productTitle=d,A.productPrice=h,A.productUrl=O,A.productImg=S,A.productQuantity=p,A.productSeller=g,A}LogCartInfo(t,o,i,a,r,n,s,c){let l={OrderTotal:-1,Currency:Te.GetCurrencyFromMarket(r)??"",PageCurrency:""};l=To.GetCartValue(a.orderTotalDataElementSelector,r),l.OrderTotal>0||(l=To.TrySimpleGetCartValue(a.orderTotalDataElementSelector,r)),t.cartValue=l.OrderTotal,t.currency=l.Currency;const u=this.GetLastCartData();if(e(a.orderSubTotalElementSelector)||(t.subTotal=at.GetOrderTotalString(a.orderSubTotalElementSelector)),t.products?.length>0){let r="Successfully extracted Cart Information",l={cartInfo:t,message:""},d=!1;("walmart.com"===o&&"/checkout/review-order"===t.cartUrl||"kohls.com"===o&&"/checkout/shopping_cart.jsp"!==t.cartUrl)&&(l=this.CartProductNameResolution(o,t,u),r+="; "+l.message+"; "+JSON.stringify(l.cartInfo),d=!0);const C=K.uuidv4();this.LogCartExtractionEvent(t,p.CartExtraction,r,h.Information,i,C);const g=new xt;if(g.OrderTotal=t.cartValue,g.CartDataCreationTime=Date.now(),g.CartId=t.cartId,g.ProductIds=t.productIds,g.Products=d?l.cartInfo.products:t.products,g.Currency=t.currency??"",t.subTotal&&(g.OrderSubTotal=Te.GetPriceStringAsNumber(t.subTotal)??-1),Oe()||this.LogCartExtractionEvent(t,p.CartExtractionError,"No access to local storage",h.Error,i),s&&void 0!==u?.Products){const o=t.products[0],i=location.pathname;if(!e(o.productTitle)){let e=!1;for(const t of u.Products)if(t.productQuantity>0&&(0===t.productUrl.indexOf(i)||t.productTitle===o.productTitle)){o.productQuantity&&!isNaN(o.productQuantity)?t.productQuantity=t.productQuantity+o.productQuantity:t.productQuantity=t.productQuantity+1,t.buyNowItem=!c,e=!0;break}if(!e){const e=u.Products;o.buyNowItem=!c,e.push(o),g.Products=e}}}const S=this.CollectGroceryInfo(a);g.CartPreTax=S.preTaxTotal,g.CartEstimatedTax=S.estimatedTax,g.ShipmentDate=S.shipmentDate,g.ExtractionId=C,ge(Bt,JSON.stringify(g)),Ce(Ht);const O=ce[o]?.useCartAtPathname;O&&location.pathname.toLocaleLowerCase().includes(O)&&at.SendStorageMessage(x.PostPurchasePathnameProducts,JSON.stringify({value:g.Products})),n&&this.SendPersistentCartMessage(o,g,i)}else{const e="Unable to get enough info about products in cart";this.LogCartExtractionEvent(t,p.CartExtractionError,e,h.Error,i)}}CollectGroceryInfo(e){const t=e.shipmentSelector,o=e.preTaxSelector,i=e.estimatedTaxSelector;let a,r,n;if(me.IsValidDataField(t)&&me.IsValidDataField(o)&&me.IsValidDataField(i))try{a=this.GetShipmentDate(t);const e=at.GetOrderTotalString(o);r=Te.GetPriceStringAsNumber(e)??-1;const s=at.GetOrderTotalString(i);n=Te.GetPriceStringAsNumber(s)??-1}catch(e){}return{shipmentDate:a,preTaxTotal:r,estimatedTax:n}}GetShipmentDate(e,t){const o=e.split(","),i=at.GetOrderTotalString(o[0]);if(i)try{const e=at.parseDate(i);return"Invalid Date"===e.toString()?"":e}catch(e){}else if(4===o.length){const e=at.GetOrderTotalString(o[1])?.trim(),t=at.GetOrderTotalString(o[2])?.trim(),i=at.GetOrderTotalString(o[3])?.trim();return new Date(`${e} ${t} ${i}`)}return""}SendPersistentCartMessage(e,t,o){try{const o=V?.PersistentCartData??"",i=fe.GetStorageObject(o)??{};i[e]={cartDataStorageInfo:t,timestamp:new Date};const a=JSON.stringify({value:JSON.stringify(i)});at.SendStorageMessage("PersistentCartData",a)}catch(e){this.LogCartExtractionEvent(t,p.CartExtractionError,"Could not send cart data to storage:  "+e?.message,h.Error,o)}}SendPersistentTravelCheckoutMessage(e,t,o){try{const o=V?.PersistentTravelData??"",i=fe.GetStorageObject(o)??{};i[e]={travelDataStorageInfo:t,timestamp:new Date};const a=JSON.stringify({value:JSON.stringify(i)});at.SendStorageMessage("PersistentTravelData",a)}catch(e){this.LogCartExtractionEvent(t,p.CartExtractionError,"Could not send travel data to storage:  "+e?.message,h.Error,o)}}ShouldSendTelemetryData(e){return this.isPersonalizationDataConsentEnabled||e!==p.CartExtraction&&e!==p.TravelCheckoutExtraction}LogCartExtractionEvent(e,t,o,i,a,r,n){let s={};this.ShouldSendTelemetryData(t)&&(s=e),n||(void 0===this.cartExtractionSuccessful&&(t===p.CartExtraction?this.cartExtractionSuccessful=!0:this.cartExtractionSuccessful=!1),s=tu(tu({},s),{},{isPersonalizationDataConsentEnabled:this.isPersonalizationDataConsentEnabled,extractionId:r??null})),at.SendLogEventMessage(s,t,a,o,i)}CollectProductInformationFromCollapsedCart(e,t){let o;const i=[];o=e.cartSelectors.collapsedCartProductImageSelector?e.cartSelectors.collapsedCartProductImageSelector:"[aria-label='collapsed item list'] img";const a=t?.querySelectorAll(o);if(void 0!==a&&a.length>0)for(const e of a){const t=e.getAttribute("alt");if(t){let o,a;const r=t.match(" quantity \\d+$");r&&r.length>0?(o=t.replace(r[0],""),a=parseInt(r[0].split(" quantity ")[1],10)):(o=t,a=1);const n=new Kt;n.productTitle=o.trim(),n.productQuantity=a,n.productImg=e?.src??"",i.push(n)}}return i}ShouldAddCartButtonListener(e,t){let o=e?.clickForCartSelector;return o||"walmart.com"!==t||(o="#cart-button-header"),o&&Be.GetAllVisibleElements(o).length>0?{shouldAddListener:!0,cartButtonSelector:o}:{shouldAddListener:!1,cartButtonSelector:""}}AddCartButtonListener(e,t,o,i,a,r,n,s,c,l,u){const d=Be.GetFirstVisibleElement(e);d?.addEventListener("click",(async()=>{me.WaitForCondition((async()=>{const e=this.GetCartCheckoutPage(o.retailerData.allCheckoutPages);if(e&&e.checkoutPageUrl!==t)return!1;o.retailerData.updateCurrentCheckoutPage(t);const i=o.retailerData.getCurrentCheckoutPage();return!!i?.cartSelectors?.cartSelector&&Be.HasVisibleElement(i?.cartSelectors?.cartSelector)}),1e3).then((e=>{if(e){o.retailerData.updateCurrentCheckoutPage(t);const e=o.retailerData.getCurrentCheckoutPage();this.TryCheckAndCollectCartInformation(i,a,e,r,l,u,e?.automatedCartExtractionEnabled,n.isCashbackEstimationSupportedForDomain,s,c)}}))}))}GetCartCheckoutPage(e){const t=e.filter((e=>e.pageType&&e.pageType===I.CheckoutPage));return t.length>0?t[0]:null}async CollectCartInfoFromProductPage(e,t,o,i,a,r,n,s){const c=t.retailerData.getCurrentCheckoutPage();if(c)if(c.addToCartOverlaySelector&&c.cartSelectors){let l=!1;const u={attributes:!0,characterData:!0,childList:!0,subtree:!0};new MutationObserver((async u=>{if(!Be.GetFirstVisibleElement(c.addToCartOverlaySelector))return void(l=!1);if(l)return;l=!0;const d=t.retailerData.getCurrentCheckoutPage();this.TryCheckAndCollectCartInformation(e,o,d,i,a,r,d?.automatedCartExtractionEnabled,t.isCashbackEstimationSupportedForDomain,n,s,!0)})).observe(document.body,u)}else if(c?.buyNowSelector&&c?.cartSelectors){const l=c.buyNowSelector,u=await me.WaitForCondition((async()=>Be.HasVisibleElement(l)),5e3).then((async()=>Be.GetFirstVisibleElement(l)));u?.addEventListener("click",(async()=>{const c=t.retailerData.getCurrentCheckoutPage();this.TryCheckAndCollectCartInformation(e,o,c,i,a,r,c?.automatedCartExtractionEnabled,t.isCashbackEstimationSupportedForDomain,n,s)}))}}notifyCartDataListeners(){try{this.onCartExtractionCallback&&this.onCartExtractionCallback()}catch(e){}}};new Set(["en-us"]),new Set(["ar-sa","da-dk","de-de","de-at","de-ch","de-li","el-gr","en-us","en-au","en-ca","en-gb","en-ie","en-in","en-my","en-nz","en-ph","en-za","es-es","es-ar","es-cl","es-co","es-mx","es-pe","es-ve","fi-fi","fr-fr","fr-be","hu-hu","it-it","ja-jp","ko-kr","nb-no","nl-nl","nl-be","pl-pl","pt-pt","pt-br","sv-se","tr-tr","zh-hk","zh-tw"]),new Set(["en-us"]),new Set(["en-us"]),new Set(["en-us"]),new Set(["da-dk","de-de","de-at","de-ch","de-li","el-gr","en-us","en-au","en-ca","en-gb","en-ie","en-in","en-za","es-es","es-ar","es-cl","es-mx","fi-fi","fr-fr","hu-hu","it-it","ja-jp","ko-kr","nb-no","nl-nl","nl-be","pl-pl","pt-pt","pt-br","sv-se","tr-tr"]),new Set(["de-de","en-us","en-au","en-ca","en-in","en-gb","fr-fr"]),new Set(["da-dk","de-de","de-at","de-ch","en-us","en-au","en-ca","en-es","en-gb","en-id","en-ie","en-in","en-my","en-nz","en-ph","en-sg","en-th","en-vn","es-mx","es-ar","es-cl","es-co","es-pe","es-us","es-ve","fi-fi","fr-fr","fr-be","fr-ca","fr-ch","it-it","nl-nl","nl-be","no-no","pt-br","sv-se","zh-hk","zh-tw"]),new Set(["en-us"]),new Set(["en-us"]);const iu=new Set(["da-dk","de-de","en-us","en-au","en-ca","en-es","en-gb","en-in","en-nz","en-sg","es-mx","es-us","fr-fr","fr-be","fr-ca","ja-jp","it-it","pt-br"]);new Set(["en-us","en-in","en-au","en-ca","es-mx","ko-kr","en-my","en-za","es-ar","zh-hk","zh-tw","en-sg","en-ph","en-nz","es-pe","es-ve","es-cl","en-ae"]),new Set(["en-us","en-gb","en-in","en-au","en-ca","ja-jp","fr-fr","de-de","es-es","it-it","nl-nl","fr-be","de-at","de-ch","nb-no","sv-se","en-ie"]),new Set(["en-us","en-au","en-ca","en-in"]);class au{constructor(){a(this,"Domain",void 0),a(this,"ProductName",void 0),a(this,"ProductSellerName",void 0),a(this,"ProductBrandName",void 0),a(this,"Url",void 0),a(this,"PageUrl",void 0),a(this,"Price",void 0),a(this,"ImageUrl",void 0),a(this,"ProductUpc",void 0),a(this,"ProductAsin",void 0),a(this,"Currency",void 0),a(this,"Market",void 0),a(this,"ProductVariant",void 0),a(this,"Badges",void 0),a(this,"OutOfStock",void 0)}static Create(e){const t=new au;return t.ProductName=e.ProductName,t.Url=e.Url,t.Price=e.Price,t.ImageUrl=e.ImageUrl,t}}var ru=au;class nu{constructor(){a(this,"ProductName",void 0),a(this,"Url",void 0),a(this,"AggregateRating",void 0),a(this,"AggregateRatingCount",void 0)}static Create(e){const t=new nu;return t.ProductName=e.ProductName,t.Url=e.Url,t.AggregateRating=e.AggregateRating,t.AggregateRatingCount=e.AggregateRatingCount,t}}var su=nu;class cu{constructor(){a(this,"ProductName",void 0),a(this,"Url",void 0),a(this,"Reviews",void 0)}static Create(e){const t=new cu;return t.ProductName=e.ProductName,t.Url=e.Url,t.Reviews=e.Reviews,t}}var lu=cu;var uu=class{constructor(){a(this,"pdpUrl","pdp_url"),a(this,"imageUrl","image_icon_url"),a(this,"asin","asin"),a(this,"productVariant","product_variant")}ExtractVariants(){let e="{product_variant: {",t="";const o={};for(let e=0;e<25;e++){t="#color_name_"+e;const i=Be.GetFirstMatchingElement(t);if(null==i)break;const a=this.ExtractVariantUrl(t);if(null===a)continue;const r=this.ExtractVariantImageUrl(t);if(null===r)continue;const n=this.ExtractVariantAsin(t);if(null===n)continue;const s=this.ExtractVariantAttribute(t),c={};c[this.pdpUrl]=a,c[this.imageUrl]=r,c[this.asin]=n,"none"!==s[0]&&(c[s[0]]=s[1]);o["variant_"+(e+1)]=c}const i={};return i[this.productVariant]=o,e=JSON.stringify(i),e}ExtractVariantUrl(e){const t=Be.GetFirstMatchingElement(e);let o="default-data-url";const i=t?.getAttribute("data-dp-url");return""!==i&&null!=i&&(o=i),"default-data-url"===o||null==o?null:o}ExtractVariantImageUrl(e){const t=e+" .a-button",o=Be.GetFirstMatchingElement(t),i=o?.getAttribute("id");if(null==i)return null;const a="#"+i+"-announce > div > div > img",r=Be.GetFirstMatchingElement(a),n=r?.src??"";return null==n?null:n}ExtractVariantAsin(e){const t=Be.GetFirstMatchingElement(e),o=t?.getAttribute("data-defaultasin");return o}ExtractVariantAttribute(e){const t=Be.GetFirstMatchingElement("#variation_color_name > div > label")?.innerText,o=Be.GetFirstMatchingElement("#variation_color_name > div > span")?.innerText;return void 0!==t&&void 0!==o&&null!==t&&null!==o?[t,o]:["none","none"]}};var du=class{ExtractVariants(){return""}};var Cu=class{static CreateVariant(e){return"amazon.com"===e.toLowerCase()?new uu:new du}};var hu=class{constructor(){a(this,"currentPageUrl",void 0),a(this,"cashBackResponseStr",void 0)}SetServiceUrl(e){this.currentPageUrl=e}SetCashbackResponseStr(e){this.cashBackResponseStr=e}async Init(){this.SetServiceUrl(new URL(window.location.href));const e=nd.GetLocalDataService(),o=e.GetCheckoutPageData(),i=e.GetItemLevelCashbackData();o.retailerData.updateCurrentCheckoutPage(_o.GetCurrentPathName());const a=o.retailerData.getCurrentCheckoutPage(),r=a?.catalogSelectors,n=o.retailerData.domainName,s=o.impressionId;if(a?.pageType===I.ProductPage){let e=r?.productPriceSelector,i=r?.productImageSelector,a=r?.productTitleSelector,l=r?.productOutOfStockSelector;c.isExperimentActive.bind(t.pdpSelectorExtraction)&&(e=e??o?.retailerData?.productPriceSelector,i=i??o?.retailerData?.productImageSelector,a=a??o?.retailerData?.productNameSelector,l=l??o?.retailerData?.productOutOfStockSelector),this.ExtractReviews(n,s,r?.reviewSelector,r?.reviewRatingSelector,r?.reviewDateSelector,r?.reviewerNameSelector,r?.productTitleSelector).catch((e=>{})),this.ExtractRatings(n,s,r?.aggregateRatingSelector,r?.aggregateRatingNumberOfRatingsSelector,r?.productTitleSelector).catch((e=>{})),this.ExtractPDPOffer(n,s,e,i,a,r?.productSellerSelector,r?.productBrandSelector,r?.productUPCSelector,r?.productASIN,l).catch((e=>{c.isExperimentActive(t.pdpSelectorExtraction)&&Wc.sendMessage(si.DataExtracted,[wt.getApiResponse().traceId,"{}"])})).then((e=>{c.isExperimentActive(t.pdpSelectorExtraction)&&Wc.sendMessage(si.DataExtracted,[wt.getApiResponse().traceId,JSON.stringify(e)])}))}else if(a?.pageType===I.SearchPage&&i?.domainData){const e=Cl.Create(i.domainData),t=ml.IsSearchPage(this.currentPageUrl,e);t?.searchKey&&this.ExtractSearchProduct(n,s,r?.productTitleSelector,r?.productPriceSelector,t.searchKey)}}async PostValidation(){}async ExtractReviews(e,t,o,i,a,r,n){if(o){await me.WaitForCondition((async()=>{if(void 0===o)return!1;const e=Be.RunQuerySelectorAll(o);return void 0!==e&&e.length>0}),5e3);try{const s=o?Be.RunQuerySelectorAll(o):[],c=i?Be.RunQuerySelectorAll(i):[],l=a?Be.RunQuerySelectorAll(a):[],u=r?Be.RunQuerySelectorAll(r):[],d=n?Be.GetFirstVisibleElement(n)?.innerText:"",C=new URL(window.location.href),g=Array.from(s).flatMap((e=>e.innerText)),S=Array.from(c).flatMap((t=>this.GetReviewRating(t,e))),O=Array.from(l).flatMap((e=>e.innerText)),A=Array.from(u).flatMap((e=>e.innerText)),m=new lu;m.Reviews=JSON.stringify([g,S,O,A,[this.currentPageUrl.toString().split("?")[0]]]),m.Url=C.toString().split("?")[0],void 0!==d&&(m.ProductName=d),this.LogCatalogExtractionEvent(m,p.CatalogExtractionReviews,"",h.Information,t)}catch(e){}}}async ExtractRatings(e,t,o,i,a){if(o&&i){await me.WaitForCondition((async()=>{if(void 0===o)return!1;return void 0!==Be.GetFirstVisibleElement(o)}),5e3);try{const r=new URL(window.location.href),n=Be.GetFirstVisibleElement(o)??void 0,s=Be.GetFirstVisibleElement(i)?.innerText,c=a?Be.GetFirstVisibleElement(a)?.innerText:"";if(void 0!==n&&void 0!==s){const o=new su;o.AggregateRating=this.GetAggregateRating(n,e),o.AggregateRatingCount=s,o.Url=r.toString().split("?")[0],o.ProductName=c??"",this.LogCatalogExtractionEvent(o,p.CatalogExtractionRating,"",h.Information,t)}}catch(e){}}}async ExtractPDPOffer(e,t,o,i,a,r,n,s,c,l){const u=new ru;if(!o||!i||!a)return u;await me.WaitForCondition((async()=>{if(void 0===a)return!1;return void 0!==Be.GetFirstVisibleElement(a)}),5e3);try{const d=new URL(window.location.href),C=Be.GetFirstVisibleElement(a)?.innerText,g=Be.GetFirstMatchingElement(i),S=g?.src??"",O=Be.GetFirstVisibleElement(o)?.innerText;let A="$",m=0,I="",T="USD";const _=fe.GetDomainName(),f=Cu.CreateVariant(_);let E="";const P=f.ExtractVariants();if(null!==P&&(E=P),O&&O.length){A=Te.ExtractCurrencyString(O),m=Te.GetPriceStringAsNumber(O);const e=Te.GetCurrencyCodeFromSymbol(A);void 0!==e&&(T=e),I=m.toString()}let N,v,D,R,y;if(r&&n&&(N=Be.GetFirstVisibleElement(r)?.innerText,v=Be.GetFirstVisibleElement(n)?.innerText),s&&(D=Be.GetFirstVisibleElement(s)?.innerText),c&&(R=Be.GetFirstVisibleElement(c)?.innerText),l&&(y=Be.GetFirstVisibleElement(l)?.innerText),void 0!==I&&void 0!==S&&void 0!==C){u.Domain=e,u.Price=I,u.ProductVariant=E,u.ImageUrl=S,u.Url=d.toString().split("?")[0],u.PageUrl=d.toString(),u.ProductName=C,u.ProductSellerName=N,u.ProductBrandName=v,u.ProductAsin=R,u.ProductUpc=D,u.Currency=T,u.OutOfStock=y;const o=[navigator.language],i=this.GetMarket(o,this.GetSupportedMarkets());let a="en-us";if(void 0!==i&&(a=i,"USD"===T)){const e=Te.GetCurrencyFromMarket(a);if(void 0!==e){const t=Te.GetCurrencyCodeFromSymbol(e);u.Currency=t}}u.Market=a,this.LogCatalogExtractionEvent(u,p.CatalogExtractionPDPOffer,"",h.Information,t)}return u}catch(e){return u}}async ExtractSearchProduct(e,t,o,i,a){if(!i||!o||!this.cashBackResponseStr)return;const r=JSON.parse(this.cashBackResponseStr);let n,s;r?.itemizedCashBackResponse?.offers?.length>0&&(n=r?.itemizedCashBackResponse?.offers[0]?.adsOffer?.name,s=r?.itemizedCashBackResponse?.offers[0]?.adsOffer?.price),await me.WaitForCondition((async()=>{if(void 0===o)return!1;return void 0!==Be.GetFirstVisibleElement(o)}),5e3);try{const r=Be.GetAllVisibleElements(o),c=Be.GetAllVisibleElements(i),l=[];if(r&&c){for(let e=0;e<10;e++)if(e<r.length&&e<c.length){const t={ProductTitle:r[e]?.innerText,ProductPrice:Te.GetPriceStringAsNumber(c[e]?.innerText)??-1};l.push(t)}if(l.length>0&&n&&s){const o={Domain:e,products:l,QueryKeyword:a,currentPageUrl:this.currentPageUrl,spbTitle:n,spbPrice:s};this.LogCatalogExtractionEvent(o,p.CatalogExtractionSearchOffers,"",h.Information,t)}}}catch(e){}}LogCatalogExtractionEvent(e,t,o,i,a){at.SendLogEventMessage(e,t,a,o,i)}GetReviewRating(e